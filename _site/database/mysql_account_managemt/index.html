<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.9.1 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>MySQL 的帐户管理 - LINOTES</title>
<meta name="description" content="用简洁清晰的语言讨论技术">



<meta property="og:type" content="article">
<meta property="og:locale" content="zh_CN">
<meta property="og:site_name" content="LINOTES">
<meta property="og:title" content="MySQL 的帐户管理">
<meta property="og:url" content="http://localhost:4000/database/mysql_account_managemt/">


  <meta property="og:description" content="用简洁清晰的语言讨论技术">



  <meta property="og:image" content="http://localhost:4000/assets/images/header/mysql.jpg">



  <meta name="twitter:site" content="@liloli">
  <meta name="twitter:title" content="MySQL 的帐户管理">
  <meta name="twitter:description" content="用简洁清晰的语言讨论技术">
  <meta name="twitter:url" content="http://localhost:4000/database/mysql_account_managemt/">

  
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="http://localhost:4000/assets/images/header/mysql.jpg">
  

  



  <meta property="article:published_time" content="2016-03-01T00:00:00+08:00">





  

  


<link rel="canonical" href="http://localhost:4000/database/mysql_account_managemt/">







  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Hawk Zhang",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="LINOTES Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- <link rel="stylesheet" href="/assets/css/vim.css"> -->



  









<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="http://localhost:4000/">LINOTES</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/app/rsync/" >Rsync 的用法</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/server/vsftpd/" >Vsftpd 的用法</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/kernel/filedescriptor/" >文件描述符简介</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/tools/tools.datastream/" >数据流处理</a>
            </li>
          
        </ul>
        
        <button class="search__toggle" type="button">
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">切换菜单</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    <div class="initial-content">
      
  











<div class="page__hero--overlay"
  style=" background-image: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)), url('http://localhost:4000/assets/images/header/mysql.jpg');"
>
  
    <div class="wrapper">
      <h1 class="page__title" itemprop="headline">
        
          MySQL 的帐户管理

        
      </h1>
      
        <p class="page__lead">
</p>
      
      
      
    </div>
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="http://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="http://localhost:4000/assets/images/bio-photo.jpg" alt="Hawk Zhang" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Hawk Zhang</h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">关注</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="http://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">北京</span>
        </li>
      

      

      
        <li>
          <a href="mailto:liloli@gmail.com">
            <meta itemprop="email" content="liloli@gmail.com" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> 电子邮箱
          </a>
        </li>
      

      

      
        <li>
          <a href="https://twitter.com/liloli" itemprop="sameAs">
            <i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter
          </a>
        </li>
      

      

      

      
        <li>
          <a href="https://www.linkedin.com/in/hawkzhang" itemprop="sameAs">
            <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn
          </a>
        </li>
      

      

      

      

      

      
        <li>
          <a href="https://github.com/liloli" itemprop="sameAs">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
    
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">切换菜单</label>
  <ul class="nav__items">
    
  </ul>
</nav>
    
  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="MySQL 的帐户管理">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="March 01, 2016">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-copy"></i> MySQL 的帐户管理</h4></header>
              <ul class="toc__menu">
  <li><a href="#用户名与密码">用户名与密码</a></li>
  <li><a href="#新增帐户">新增帐户</a></li>
  <li><a href="#删除帐户">删除帐户</a></li>
  <li><a href="#使用角色">使用角色</a>
    <ul>
      <li><a href="#mysql-角色管理的能力">MySQL 角色管理的能力</a></li>
      <li><a href="#创建角色并为其分配权限">创建角色并为其分配权限</a></li>
      <li><a href="#定义强制角色">定义强制角色</a></li>
      <li><a href="#查看角色的权限">查看角色的权限</a></li>
      <li><a href="#激活角色">激活角色</a></li>
      <li><a href="#撤消角色撤消权限">撤消角色、撤消权限</a></li>
      <li><a href="#删除角色">删除角色</a></li>
      <li><a href="#用户与角色的互换">用户与角色的互换</a></li>
    </ul>
  </li>
  <li><a href="#系统保留的帐户">系统保留的帐户</a></li>
  <li><a href="#限定帐户资源">限定帐户资源</a></li>
  <li><a href="#设置帐户密码">设置帐户密码</a></li>
  <li><a href="#密码管理">密码管理</a>
    <ul>
      <li><a href="#密码过期策略">密码过期策略</a></li>
      <li><a href="#密码重用策略">密码重用策略</a></li>
    </ul>
  </li>
  <li><a href="#服务端对密码过期的处理">服务端对密码过期的处理</a></li>
  <li><a href="#用插件验证身份">用插件验证身份</a>
    <ul>
      <li><a href="#可用的验证插件">可用的验证插件</a></li>
      <li><a href="#验证插件的使用方法">验证插件的使用方法</a></li>
      <li><a href="#验证插件对客户端和服务端的兼容性">验证插件对客户端和服务端的兼容性</a></li>
    </ul>
  </li>
  <li><a href="#代理用户">代理用户</a>
    <ul>
      <li><a href="#实现用户代理的条件">实现用户代理的条件</a></li>
      <li><a href="#为代理授权">为代理授权</a></li>
      <li><a href="#默认的代理用户">默认的代理用户</a></li>
      <li><a href="#默认的代理用户与匿名帐户户的冲突">默认的代理用户与匿名帐户户的冲突</a></li>
      <li><a href="#服务端对代理用户映射的支持">服务端对代理用户映射的支持</a></li>
      <li><a href="#代理用户的系统变量">代理用户的系统变量</a></li>
    </ul>
  </li>
  <li><a href="#锁定帐户">锁定帐户</a></li>
</ul>
            </nav>
          </aside>
        
        <h2 id="用户名与密码">用户名与密码</h2>

<p>本节内容主要引自 <a href="https://dev.mysql.com/doc/refman/8.0/en/"> MySQL 8.0 Reference Manual </a></p>

<p>MySQL 把帐户保存在 <code class="highlighter-rouge">mysql</code> 系统数据库的 <strong><code class="highlighter-rouge">user</code> 表</strong> 中。每个帐户由 <strong>用户名</strong> 和 <strong>客户端主机</strong> 两部分组成。</p>

<p>每个帐户可以拥有密码，MySQL 还支持验证的插件，因此完全可以使用某个外部的验证方法进行帐户的验证。</p>

<p>MySQL 的用户名和密码与操作系统中使用的有一些不同：</p>

<h4 id="用户名与操作系统无关">用户名与操作系统无关</h4>

<p>MySQL 的用户名与操作系统中的用户名没有任何关系。</p>

<p>许多 MySQL 的客户端默认会尝试使用当前的 Linux 用户名做为 MySQL 用户名，但这只是为了方便而已。这个默认值可以通过使用 <code class="highlighter-rouge">-u</code> 选项来覆盖，因此任何可以尝试用任何用户名来连接服务端，因此应该为所有 MySQL 帐户设置密码，以保证数据的安全。</p>

<h4 id="用户名长度限制">用户名长度限制</h4>

<p>MySQL 用户名最多为 32 个字符，操作系统用户名的长度限制通常与此有所区别，如 Unix 默认为 8 个字符，一般的 Linux 为 32 个字符。</p>

<p>在服务端和客户端中，对于 MySQL 用户名长度的限制是硬编码的，如果想通过修改 <code class="highlighter-rouge">mysql</code> 数据库来规避是不可能实现的。</p>

<p>不要尝试以任何手动方式去修改 <code class="highlighter-rouge">mysql</code> 数据库中表格的结构，服务端会忽略所有的改动。</p>

<h4 id="内部密码与外部密码">内部密码与外部密码</h4>

<p>MySQL 本机的用户验证是通过 <code class="highlighter-rouge">mysql_native_password</code> 插件实现的，服务端使用这种本机验证方法时，用的是 <code class="highlighter-rouge">user</code> 表中保存的密码。如果使用第三方的验证插件，就不一定用这个密码了，可以使用保存于外部的密码。</p>

<h4 id="密码的加密">密码的加密</h4>

<p>保存在 <code class="highlighter-rouge">user</code> 表格中的密码是使用插件指定的机制加密过的。</p>

<h4 id="字符集">字符集</h4>

<p>如果用户名和密码只包含 ASCII 码，连接服务端时，可以不考虑字符集的设置。</p>

<p>如果用户名和密码中有非 ASCII 字符，客户端则需要使用 <code class="highlighter-rouge">MYSQL_SET_CHARSET_NAME</code> 选项，以及适当的字符集做参数，来调用 C API 函数 <code class="highlighter-rouge">mysql_options()</code>，这将会使用指定的字符集来进行验证。否则验证会失败。</p>

<p>标准的 MySQL 客户端程序都支持 <code class="highlighter-rouge">--default-character-set</code> 选项，该选项会调用 <code class="highlighter-rouge">mysql_option()</code> 函数。</p>

<h2 id="新增帐户">新增帐户</h2>

<p>使用帐户管理语句可以新建帐户，同时会建立他们的权限，如 <code class="highlighter-rouge">CREATE USER</code> 和 <code class="highlighter-rouge">GRANT</code> 语句，这些语句会促使授权表发生适当的改动。</p>

<p>另一个创建帐户的方法是使用可视化工具 MySQL Workbench，或者第三方程序，如 <code class="highlighter-rouge">phpMyAdmin</code>。</p>

<h4 id="以-root-连接到服务端">以 root 连接到服务端</h4>

<p>以 root 身份连接到服务端，因为他有 <code class="highlighter-rouge">CREATE USER</code> 的权限。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mysql <span class="nt">-u</span> root mysql <span class="nt">-p</span>
</code></pre></div></div>

<h4 id="创建帐户">创建帐户</h4>

<h5 id="create-user-语句"><code class="highlighter-rouge">CREATE USER</code> 语句</h5>

<p>使用 <code class="highlighter-rouge">CREATE USER</code> 语句来 <strong>创建帐户</strong>，同时可以用明文 <strong>指定密码</strong>。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'user'</span><span class="o">@</span><span class="s1">'host'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'password'</span><span class="p">;</span>
</code></pre></div></div>

<h5 id="grant-语句"><code class="highlighter-rouge">GRANT</code> 语句</h5>

<p>使用 <code class="highlighter-rouge">GRANT</code> 语句为帐户 <strong>授予权限</strong>。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">GRANT</span> <span class="k">privileges</span> <span class="k">ON</span> <span class="n">priv_level</span> <span class="k">TO</span> <span class="n">user_or_role</span> <span class="p">[</span><span class="k">WITH</span> <span class="k">GRANT</span> <span class="k">OPTION</span><span class="p">];</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">GRANT</code> 接权限列表，用逗号分隔</p>

<p><code class="highlighter-rouge">ON</code> 表明该语句用于授予权限</p>

<p><code class="highlighter-rouge">priv_level</code> 权限授权的级别：</p>

<p>级别是指权限所能作用的范围，如全局、数据库、表、例程等。如：</p>

<ul>
  <li><code class="highlighter-rouge">*.*</code> 所有数据库中的所有对象</li>
  <li><code class="highlighter-rouge">db.*</code> 数据库 <code class="highlighter-rouge">db</code> 的所有对象</li>
  <li><code class="highlighter-rouge">db.tbl</code> 数据库 <code class="highlighter-rouge">db</code> 的 <code class="highlighter-rouge">tbl</code> 表格</li>
</ul>

<p><code class="highlighter-rouge">WITH</code> 子句用于允许该用户为他人授予权限，<code class="highlighter-rouge">WITH GRANT OPTION</code> 允许用户把自己极有的权限授予他人。</p>

<h4 id="查看以确认">查看以确认</h4>

<h5 id="show-grants-查看为帐户分配的权限"><code class="highlighter-rouge">SHOW GRANTS</code> 查看为帐户分配的权限</h5>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SHOW</span> <span class="n">GRANTS</span> <span class="k">FOR</span> <span class="s1">'admin'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">;</span>
<span class="o">+</span><span class="c1">-----------------------------------------------------+</span>
<span class="o">|</span> <span class="n">Grants</span> <span class="k">for</span> <span class="k">admin</span><span class="o">@</span><span class="n">localhost</span>                          <span class="o">|</span>
<span class="o">+</span><span class="c1">-----------------------------------------------------+</span>
<span class="o">|</span> <span class="k">GRANT</span> <span class="n">RELOAD</span><span class="p">,</span> <span class="n">PROCESS</span> <span class="k">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'admin'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">-----------------------------------------------------+</span>
</code></pre></div></div>

<h5 id="show-create-user-查看帐户非权限属性"><code class="highlighter-rouge">SHOW CREATE USER</code> 查看帐户非权限属性：</h5>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SHOW</span> <span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'admin'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="err">\</span><span class="k">G</span>
<span class="o">***************************</span> <span class="mi">1</span><span class="p">.</span> <span class="k">row</span> <span class="o">***************************</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="k">for</span> <span class="k">admin</span><span class="o">@</span><span class="n">localhost</span><span class="p">:</span> <span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'admin'</span><span class="o">@</span><span class="s1">'localhost'</span>
<span class="n">IDENTIFIED</span> <span class="k">WITH</span> <span class="s1">'mysql_native_password'</span>
<span class="k">AS</span> <span class="s1">'*67ACDEBDAB923990001F0FFB017EB8ED41861105'</span>
<span class="n">REQUIRE</span> <span class="k">NONE</span> <span class="n">PASSWORD</span> <span class="n">EXPIRE</span> <span class="k">DEFAULT</span> <span class="n">ACCOUNT</span> <span class="n">UNLOCK</span>
</code></pre></div></div>

<h4 id="范例">范例</h4>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'finley'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'password'</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">PRIVILEGES</span> <span class="k">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'finley'</span><span class="o">@</span><span class="s1">'localhost'</span>
    <span class="o">-&gt;</span>     <span class="k">WITH</span> <span class="k">GRANT</span> <span class="k">OPTION</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'finley'</span><span class="o">@</span><span class="s1">'%'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'password'</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">PRIVILEGES</span> <span class="k">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'finley'</span><span class="o">@</span><span class="s1">'%'</span>
    <span class="o">-&gt;</span>     <span class="k">WITH</span> <span class="k">GRANT</span> <span class="k">OPTION</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'admin'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'password'</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">GRANT</span> <span class="n">RELOAD</span><span class="p">,</span><span class="n">PROCESS</span> <span class="k">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'admin'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'dummy'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">'finley'@'localhost'</code> 和 <code class="highlighter-rouge">'finley'@'%'</code> 都被赋予了管理员权限，<code class="highlighter-rouge">ALL PRIVILEGES ON *.*</code>。</li>
  <li><code class="highlighter-rouge">'finley'@'localhost'</code> 只能从服务端本地主机连接</li>
  <li><code class="highlighter-rouge">'finley'@'%'</code> 可以从任何主机连接</li>
  <li>如果原来有 <code class="highlighter-rouge">localhost</code> 的匿名帐户，则创建 <code class="highlighter-rouge">'finley'@'localhost'</code> 就很有必要，否则 <code class="highlighter-rouge">finley</code> 会被作为匿名用户来对待。</li>
  <li>‘admin’@’localhost’ 只能从服务端主机连接，他被赋予了 <code class="highlighter-rouge">RELOAD</code> 和 <code class="highlighter-rouge">PROCESS</code> 管理权限，有了这些权限，<code class="highlighter-rouge">admin</code> 就可以执行 <code class="highlighter-rouge">mysqladmin reload</code>、<code class="highlighter-rouge">mysqladmin refresh</code>、<code class="highlighter-rouge">mysqladmin flush-xxx</code>、<code class="highlighter-rouge">mysqladmin processlist</code> 这些命令。但不包含访问数据库的权限。</li>
  <li>‘dummy’@’localhost’ 没有密码，这样不安全，不推荐。只能从本地连接，没有权限。</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'custom'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'password'</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">GRANT</span> <span class="k">SELECT</span><span class="p">,</span><span class="k">INSERT</span><span class="p">,</span><span class="k">UPDATE</span><span class="p">,</span><span class="k">DELETE</span><span class="p">,</span><span class="k">CREATE</span><span class="p">,</span><span class="k">DROP</span>
    <span class="o">-&gt;</span>     <span class="k">ON</span> <span class="n">bankaccount</span><span class="p">.</span><span class="o">*</span>
    <span class="o">-&gt;</span>     <span class="k">TO</span> <span class="s1">'custom'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'custom'</span><span class="o">@</span><span class="s1">'host47.example.com'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'password'</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">GRANT</span> <span class="k">SELECT</span><span class="p">,</span><span class="k">INSERT</span><span class="p">,</span><span class="k">UPDATE</span><span class="p">,</span><span class="k">DELETE</span><span class="p">,</span><span class="k">CREATE</span><span class="p">,</span><span class="k">DROP</span>
    <span class="o">-&gt;</span>     <span class="k">ON</span> <span class="n">expenses</span><span class="p">.</span><span class="o">*</span>
    <span class="o">-&gt;</span>     <span class="k">TO</span> <span class="s1">'custom'</span><span class="o">@</span><span class="s1">'host47.example.com'</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'custom'</span><span class="o">@</span><span class="s1">'%.example.com'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'password'</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">GRANT</span> <span class="k">SELECT</span><span class="p">,</span><span class="k">INSERT</span><span class="p">,</span><span class="k">UPDATE</span><span class="p">,</span><span class="k">DELETE</span><span class="p">,</span><span class="k">CREATE</span><span class="p">,</span><span class="k">DROP</span>
    <span class="o">-&gt;</span>     <span class="k">ON</span> <span class="n">customer</span><span class="p">.</span><span class="o">*</span>
    <span class="o">-&gt;</span>     <span class="k">TO</span> <span class="s1">'custom'</span><span class="o">@</span><span class="s1">'%.example.com'</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">GRANT</code> 语句中 <code class="highlighter-rouge">ON</code> 子句指定了具体的权限级别，如 <code class="highlighter-rouge">ON bankaccount.*</code> 代表权限作用于数据库 <code class="highlighter-rouge">bankaccount</code> 的所有表。</p>

<p><code class="highlighter-rouge">'custom'@'host47.example.com'</code> 只能从主机 <code class="highlighter-rouge">host47.example.com</code> 连接。</p>

<h2 id="删除帐户">删除帐户</h2>

<p>使用 <code class="highlighter-rouge">DROP USER</code> 语句删除帐户：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">USER</span> <span class="s1">'jeffrey'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="使用角色">使用角色</h2>

<p>MySQL 使用角色来代表一组命名的权限。</p>

<p>可以给一个用户帐户分配各种角色，这些角色会给帐户授予每个角色所关联的不同的权限。通过更换角色，每个帐户可以轻易地更换一组不同的权限。</p>

<p>除非有特殊说明，否则本节所有语句都需要使用 root 身份运行。</p>

<p>本节内容使用同一个范例场景：</p>

<ul>
  <li>有一个应用使用名为 <code class="highlighter-rouge">app_db</code> 的数据库</li>
  <li>与该程序相关的帐户可以有程序员，负责创建、维护应用，还可以有程序的用户，会与程序交互</li>
  <li>程序员需要对数据库有完全的访问权限，一些用户需要读，另一些用户需要读写</li>
</ul>

<h3 id="mysql-角色管理的能力">MySQL 角色管理的能力</h3>

<ul>
  <li>用 <code class="highlighter-rouge">CREATE ROLE</code> 创建角色，用 <code class="highlighter-rouge">DROP ROLE</code> 删除角色</li>
  <li>用 <code class="highlighter-rouge">GRANT</code> 为帐户和角色分配权限，用 <code class="highlighter-rouge">REVOKE</code> 为帐户和角色撤消权限</li>
  <li><code class="highlighter-rouge">SHOW GRANTS</code> 查看为帐户分配的权限和角色</li>
  <li><code class="highlighter-rouge">SET DEFAULT ROLE</code> 为帐户设置默认激活的角色</li>
  <li><code class="highlighter-rouge">SET ROLE</code> 在当前会话中改变激活的角色</li>
  <li><code class="highlighter-rouge">CURRENT_ROLE()</code> 函数查看当前会话中激活的角色</li>
  <li>系统变量 <code class="highlighter-rouge">mandatory_roles</code> 用于定义强制角色，<code class="highlighter-rouge">activate_all_roles_on_login</code> 让用户在登陆服务端时自动激活被分配的角色。</li>
</ul>

<h3 id="创建角色并为其分配权限">创建角色并为其分配权限</h3>

<p>为多个帐户单独分配权限的做法效率很低，把每一组权限命名，成为一个角色，这样一来，为用户帐户分配角色就变得高效、灵活。</p>

<h4 id="创建角色">创建角色</h4>

<p>用 <code class="highlighter-rouge">CREATE ROLE</code> 创建角色：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">ROLE</span> <span class="s1">'app_developer'</span><span class="p">,</span> <span class="s1">'app_read'</span><span class="p">,</span> <span class="s1">'app_write'</span><span class="p">;</span>
</code></pre></div></div>

<p>角色名很像帐户名，也是由用户和主机两部分组成的，即 <code class="highlighter-rouge">'user'@'host'</code>。如果主机部分省略，系统默认为 <code class="highlighter-rouge">'%'</code>。</p>

<p>与帐户名不同的是，<strong>用户名不能为空</strong>。</p>

<h4 id="为角色分配权限">为角色分配权限</h4>

<p>使用 <code class="highlighter-rouge">GRANT</code> 语句为角色分配权限：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">ON</span> <span class="n">app_db</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'app_developer'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">SELECT</span> <span class="k">ON</span> <span class="n">app_db</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'app_read'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">INSERT</span><span class="p">,</span> <span class="k">UPDATE</span><span class="p">,</span> <span class="k">DELETE</span> <span class="k">ON</span> <span class="n">app_db</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'app_write'</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="为帐户分配角色">为帐户分配角色</h4>

<p>新建帐户：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'dev1'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'dev1pass'</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'read_user1'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'read_user1pass'</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'read_user2'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'read_user2pass'</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'rw_user1'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'rw_user1pass'</span><span class="p">;</span>
</code></pre></div></div>

<p>分配角色：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">GRANT</span> <span class="s1">'app_developer'</span> <span class="k">TO</span> <span class="s1">'dev1'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="s1">'app_read'</span> <span class="k">TO</span> <span class="s1">'read_user1'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="s1">'read_user2'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="s1">'app_read'</span><span class="p">,</span> <span class="s1">'app_write'</span> <span class="k">TO</span> <span class="s1">'rw_user1'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">;</span>
</code></pre></div></div>

<p>可以把一个角色分配给一个或多个用户，也可以为一个用户分配多个角色。</p>

<p>用 <code class="highlighter-rouge">GRANT</code> 语句为用户分配角色时，没有 <code class="highlighter-rouge">ON</code> 子句，只用于权限的分配。</p>

<h3 id="定义强制角色">定义强制角色</h3>

<p>通过把角色赋给 <code class="highlighter-rouge">mandatory_roles</code> 系统变量，可以将某些角色设定为强制角色，服务端会认为每个用户都有这些角色，因此无需显式分配给任何帐户。</p>

<p>设置 <code class="highlighter-rouge">mandatory_roles</code> 需要 <code class="highlighter-rouge">ROLE_ADMIN</code> 权限。以及 <code class="highlighter-rouge">SYSTEM_VARIABLES_ADMIN</code> 或 <code class="highlighter-rouge">SUPER</code> 权限，用于设置全局系统变量的权限。</p>

<h4 id="在配置文件中指定">在配置文件中指定</h4>

<p>可以在服务端配置文件 <code class="highlighter-rouge">my.cnf</code> 中指定该变量：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>mysqld]
<span class="nv">mandatory_roles</span><span class="o">=</span><span class="s1">'role1,role2@localhost,r3@%.example.com'</span>
</code></pre></div></div>

<h4 id="在运行时指定">在运行时指定</h4>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SET</span> <span class="n">PERSIST</span> <span class="n">mandatory_roles</span> <span class="o">=</span> <span class="s1">'role1,role2@localhost,r3@%.example.com'</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">SET PERSIST</code> 语句用于给运行中的 MySQL 实例指定强制角色，服务端重启也依然有效。</p>

<p>如果希望仅仅修改运行时的变量值，而不希望保存，可以用关键字 <code class="highlighter-rouge">SET GLOBAL</code>。</p>

<h4 id="强制角色的激活时机">强制角色的激活时机</h4>

<p>强制角色与显式授予角色一样，直到角色激活才会生效。用户登陆时，如果启用了系统变量 <code class="highlighter-rouge">activate_all_roles_on_login</code>，系统会激活所有授权的角色；否则，只激活默认角色。</p>

<p>在运行时，<code class="highlighter-rouge">SET ROLE</code> 会立即激活角色。</p>

<h4 id="强制角色的撤消">强制角色的撤消</h4>

<p>强制角色无法使用 <code class="highlighter-rouge">REVOKE</code>、<code class="highlighter-rouge">DROP ROLE</code>、<code class="highlighter-rouge">DROP USER</code> 来撤消。</p>

<h4 id="强制角色中不存在的角色">强制角色中不存在的角色</h4>

<p>如果 <code class="highlighter-rouge">mandatory_roles</code> 中的某个角色不存在于 <code class="highlighter-rouge">mysql.user</code> 系统表中，该角色不会分配给用户。</p>

<p>当服务端为用户激活角色时，遇到不存在的角色会忽略掉，并在错误日志中记录一条警告消息。</p>

<p>如果在这之后，该角色被创建了，可以用 <code class="highlighter-rouge">FLUSH PRIVILEGES</code> 来冲洗一下，服务端就认可它了。</p>

<h3 id="查看角色的权限">查看角色的权限</h3>

<p>用 <code class="highlighter-rouge">SHOW GRANTS</code> 可以查看帐户的权限，但并未将权限扩展成为角色所代表的具体的权限。要想同时也显示角色权限，需要加一个 <code class="highlighter-rouge">USING</code> 子句，用来指定授予的角色。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SHOW</span> <span class="n">GRANTS</span> <span class="k">FOR</span> <span class="s1">'rw_user1'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="k">USING</span> <span class="s1">'app_read'</span><span class="p">,</span> <span class="s1">'app_write'</span><span class="p">;</span>
<span class="o">+</span><span class="c1">------------------------------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">Grants</span> <span class="k">for</span> <span class="n">rw_user1</span><span class="o">@</span><span class="n">localhost</span>                                                <span class="o">|</span>
<span class="o">+</span><span class="c1">------------------------------------------------------------------------------+</span>
<span class="o">|</span> <span class="k">GRANT</span> <span class="k">USAGE</span> <span class="k">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="nv">`rw_user1`</span><span class="o">@</span><span class="nv">`localhost`</span>                                 <span class="o">|</span>
<span class="o">|</span> <span class="k">GRANT</span> <span class="k">SELECT</span><span class="p">,</span> <span class="k">INSERT</span><span class="p">,</span> <span class="k">UPDATE</span><span class="p">,</span> <span class="k">DELETE</span> <span class="k">ON</span> <span class="nv">`app_db`</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="nv">`rw_user1`</span><span class="o">@</span><span class="nv">`localhost`</span> <span class="o">|</span>
<span class="o">|</span> <span class="k">GRANT</span> <span class="nv">`app_read`</span><span class="o">@</span><span class="nv">`%`</span><span class="p">,</span><span class="nv">`app_write`</span><span class="o">@</span><span class="nv">`%`</span> <span class="k">TO</span> <span class="nv">`rw_user1`</span><span class="o">@</span><span class="nv">`localhost`</span>               <span class="o">|</span>
<span class="o">+</span><span class="c1">------------------------------------------------------------------------------+</span>
</code></pre></div></div>

<h3 id="激活角色">激活角色</h3>

<p>为用户分配的角色可以在用户的会话当中激活或暂停。如果会话中某个角色处于激活状态，其权限也同时有效，否则就无效。</p>

<p>使用 <code class="highlighter-rouge">CURRENT_ROLE()</code> 函数来 <strong>查看当前</strong> 会话中激活的角色：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="k">CURRENT_ROLE</span><span class="p">();</span>
<span class="o">+</span><span class="c1">----------------+</span>
<span class="o">|</span> <span class="k">CURRENT_ROLE</span><span class="p">()</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------------+</span>
<span class="o">|</span> <span class="k">NONE</span>           <span class="o">|</span>
<span class="o">+</span><span class="c1">----------------+</span>
</code></pre></div></div>

<h4 id="为用户设置默认角色">为用户设置默认角色</h4>

<p>若想指定用户每次连接到服务端时要激活哪些角色，可使用 <code class="highlighter-rouge">SET DEFAULT ROLE</code> 来指定。</p>

<p>语法：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SET</span> <span class="k">DEFAULT</span> <span class="k">ROLE</span> <span class="err">{</span><span class="k">NONE</span> <span class="o">|</span> <span class="k">ALL</span> <span class="o">|</span> <span class="k">role</span> <span class="p">[,</span> <span class="k">role</span> <span class="p">]</span> <span class="p">...</span><span class="err">}</span> <span class="k">TO</span> <span class="k">user</span> <span class="p">[,</span> <span class="k">user</span> <span class="p">]</span> <span class="p">...</span>
</code></pre></div></div>

<p>范例：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SET</span> <span class="k">DEFAULT</span> <span class="k">ROLE</span> <span class="k">ALL</span> <span class="k">TO</span>
  <span class="s1">'dev1'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">,</span>
  <span class="s1">'read_user1'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">,</span>
  <span class="s1">'read_user2'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">,</span>
  <span class="s1">'rw_user1'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">;</span>
</code></pre></div></div>

<p>此处的 <code class="highlighter-rouge">ALL</code> 是指之前用 <code class="highlighter-rouge">GRANT</code> 语句为用户分配的角色，如给 <code class="highlighter-rouge">rw_user1</code> 分配的是 <code class="highlighter-rouge">'app_read'</code> 和 <code class="highlighter-rouge">'app_write'</code> 两个角色。因此，把 <code class="highlighter-rouge">ALL</code> 设为其默认角色以后，该用户成功连接服务端后，其 <code class="highlighter-rouge">CURRENT_ROLE()</code> 的初始值就是这两个角色：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="k">CURRENT_ROLE</span><span class="p">();</span>
<span class="o">+</span><span class="c1">--------------------------------+</span>
<span class="o">|</span> <span class="k">CURRENT_ROLE</span><span class="p">()</span>                 <span class="o">|</span>
<span class="o">+</span><span class="c1">--------------------------------+</span>
<span class="o">|</span> <span class="nv">`app_read`</span><span class="o">@</span><span class="nv">`%`</span><span class="p">,</span><span class="nv">`app_write`</span><span class="o">@</span><span class="nv">`%`</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">--------------------------------+</span>
</code></pre></div></div>

<p>如果希望用户连接到服务端时能自动激活角色，需要启用  <code class="highlighter-rouge">activate_all_roles_on_login</code> 系统变量，默认是关闭的。</p>

<p>在会话中，用户可以用 <code class="highlighter-rouge">SET ROLE</code> 来修改激活的角色：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SET</span> <span class="k">ROLE</span> <span class="k">NONE</span><span class="p">;</span> <span class="k">SELECT</span> <span class="k">CURRENT_ROLE</span><span class="p">();</span>
<span class="o">+</span><span class="c1">----------------+</span>
<span class="o">|</span> <span class="k">CURRENT_ROLE</span><span class="p">()</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------------+</span>
<span class="o">|</span> <span class="k">NONE</span>           <span class="o">|</span>
<span class="o">+</span><span class="c1">----------------+</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">SET ROLE NONE</code> 暂停所有角色。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SET</span> <span class="k">ROLE</span> <span class="k">ALL</span> <span class="k">EXCEPT</span> <span class="s1">'app_write'</span><span class="p">;</span> <span class="k">SELECT</span> <span class="k">CURRENT_ROLE</span><span class="p">();</span>
<span class="o">+</span><span class="c1">----------------+</span>
<span class="o">|</span> <span class="k">CURRENT_ROLE</span><span class="p">()</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------------+</span>
<span class="o">|</span> <span class="nv">`app_read`</span><span class="o">@</span><span class="nv">`%`</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------------+</span>
</code></pre></div></div>

<p>把 <code class="highlighter-rouge">app_write</code> 角色排除掉，只激活 <code class="highlighter-rouge">app_read</code> 角色。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SET</span> <span class="k">ROLE</span> <span class="k">DEFAULT</span><span class="p">;</span> <span class="k">SELECT</span> <span class="k">CURRENT_ROLE</span><span class="p">();</span>
<span class="o">+</span><span class="c1">--------------------------------+</span>
<span class="o">|</span> <span class="k">CURRENT_ROLE</span><span class="p">()</span>                 <span class="o">|</span>
<span class="o">+</span><span class="c1">--------------------------------+</span>
<span class="o">|</span> <span class="nv">`app_read`</span><span class="o">@</span><span class="nv">`%`</span><span class="p">,</span><span class="nv">`app_write`</span><span class="o">@</span><span class="nv">`%`</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">--------------------------------+</span>
</code></pre></div></div>

<p>恢复默认角色。</p>

<h3 id="撤消角色撤消权限">撤消角色、撤消权限</h3>

<p><code class="highlighter-rouge">REVOKE</code> 语法：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">REVOKE</span> <span class="k">role</span> <span class="k">FROM</span> <span class="k">user</span><span class="p">;</span>
</code></pre></div></div>

<p>在系统变量 <code class="highlighter-rouge">mandatory_roles</code> 中指定的角色无法撤消。</p>

<p><code class="highlighter-rouge">REVOKE</code> 也可用于修改角色的权限，改动不仅作用于角色自身，还会影响授予角色的帐户。</p>

<p>假设现在想临时地把所有该程序的用户都变成只读，可以用 <code class="highlighter-rouge">REVOKE</code> 把角色 <code class="highlighter-rouge">app_write</code> 的部分权限撤消：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">REVOKE</span> <span class="k">INSERT</span><span class="p">,</span> <span class="k">UPDATE</span><span class="p">,</span> <span class="k">DELETE</span> <span class="k">ON</span> <span class="n">app_db</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="s1">'app_write'</span><span class="p">;</span>
</code></pre></div></div>

<p>用 <code class="highlighter-rouge">SHOW GRANTS</code> 查看该角色剩余的权限：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SHOW</span> <span class="n">GRANTS</span> <span class="k">FOR</span> <span class="s1">'app_write'</span><span class="p">;</span>
<span class="o">+</span><span class="c1">---------------------------------------+</span>
<span class="o">|</span> <span class="n">Grants</span> <span class="k">for</span> <span class="n">app_write</span><span class="o">@%</span>                <span class="o">|</span>
<span class="o">+</span><span class="c1">---------------------------------------+</span>
<span class="o">|</span> <span class="k">GRANT</span> <span class="k">USAGE</span> <span class="k">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="nv">`app_write`</span><span class="o">@</span><span class="nv">`%`</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">---------------------------------------+</span>
</code></pre></div></div>

<p>因为对角色权限的修改会直接影响到使用该角色的用户，因此 <code class="highlighter-rouge">rw_user1</code> 用户现在已经没有了对表格进行修改的权限，即 <code class="highlighter-rouge">INSERT</code>、<code class="highlighter-rouge">UPDATE</code>、<code class="highlighter-rouge">DELETE</code> 这几个权限已经消失：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SHOW</span> <span class="n">GRANTS</span> <span class="k">FOR</span> <span class="s1">'rw_user1'</span><span class="o">@</span><span class="s1">'localhost'</span>
       <span class="k">USING</span> <span class="s1">'app_read'</span><span class="p">,</span> <span class="s1">'app_write'</span><span class="p">;</span>
<span class="o">+</span><span class="c1">----------------------------------------------------------------+</span>
<span class="o">|</span> <span class="n">Grants</span> <span class="k">for</span> <span class="n">rw_user1</span><span class="o">@</span><span class="n">localhost</span>                                  <span class="o">|</span>
<span class="o">+</span><span class="c1">----------------------------------------------------------------+</span>
<span class="o">|</span> <span class="k">GRANT</span> <span class="k">USAGE</span> <span class="k">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="nv">`rw_user1`</span><span class="o">@</span><span class="nv">`localhost`</span>                   <span class="o">|</span>
<span class="o">|</span> <span class="k">GRANT</span> <span class="k">SELECT</span> <span class="k">ON</span> <span class="nv">`app_db`</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="nv">`rw_user1`</span><span class="o">@</span><span class="nv">`localhost`</span>           <span class="o">|</span>
<span class="o">|</span> <span class="k">GRANT</span> <span class="nv">`app_read`</span><span class="o">@</span><span class="nv">`%`</span><span class="p">,</span><span class="nv">`app_write`</span><span class="o">@</span><span class="nv">`%`</span> <span class="k">TO</span> <span class="nv">`rw_user1`</span><span class="o">@</span><span class="nv">`localhost`</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------------------------------------------------------------+</span>
</code></pre></div></div>

<p>此时，用户 <code class="highlighter-rouge">rw_user1</code> 已从原来的读写用户变成了只读用户。同时受到影响的还有 <code class="highlighter-rouge">app_write</code> 角色。</p>

<p>要想恢复，只需把之前撤消的权限用 <code class="highlighter-rouge">GRANT</code> 再给加上：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">GRANT</span> <span class="k">INSERT</span><span class="p">,</span> <span class="k">UPDATE</span><span class="p">,</span> <span class="k">DELETE</span> <span class="k">ON</span> <span class="n">app_db</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'app_write'</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="删除角色">删除角色</h3>

<p>要想从系统中删除角色，使用 <code class="highlighter-rouge">DROP ROLE</code> 语句：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">ROLE</span> <span class="s1">'app_read'</span><span class="p">,</span> <span class="s1">'app_write'</span><span class="p">;</span>
</code></pre></div></div>

<p>角色被删除以后，它也会从被分配的用户撤消。</p>

<p>系统变量 <code class="highlighter-rouge">mandatory_roles</code> 中的角色不能删除。</p>

<h3 id="用户与角色的互换">用户与角色的互换</h3>

<p>帐户和角色可以互换使用。可以把用户帐户作为角色，把它分配给其它用户或角色。效果与为用户分配角色一样，会把该用户的权限分配给别人。</p>

<p>也就是说，可以把用户分配给另一个用户，角色分配给用户，用户分配给角色，角色分配给角色，真 TM 乱。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'u1'</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">ROLE</span> <span class="s1">'r1'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">SELECT</span> <span class="k">ON</span> <span class="n">db1</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'u1'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">SELECT</span> <span class="k">ON</span> <span class="n">db2</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'r1'</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'u2'</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">ROLE</span> <span class="s1">'r2'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="s1">'u1'</span><span class="p">,</span> <span class="s1">'r1'</span> <span class="k">TO</span> <span class="s1">'u2'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="s1">'u1'</span><span class="p">,</span> <span class="s1">'r1'</span> <span class="k">TO</span> <span class="s1">'r2'</span><span class="p">;</span>
</code></pre></div></div>

<p>上述这么一折腾，用户 <code class="highlighter-rouge">u2</code> 和角色 <code class="highlighter-rouge">r2</code> 都从 <code class="highlighter-rouge">u1</code> 和 <code class="highlighter-rouge">r1</code> 那时获得了相应的权限。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SHOW</span> <span class="n">GRANTS</span> <span class="k">FOR</span> <span class="s1">'u2'</span> <span class="k">USING</span> <span class="s1">'u1'</span><span class="p">,</span> <span class="s1">'r1'</span><span class="p">;</span>
<span class="o">+</span><span class="c1">-------------------------------------+</span>
<span class="o">|</span> <span class="n">Grants</span> <span class="k">for</span> <span class="n">u2</span><span class="o">@%</span>                     <span class="o">|</span>
<span class="o">+</span><span class="c1">-------------------------------------+</span>
<span class="o">|</span> <span class="k">GRANT</span> <span class="k">USAGE</span> <span class="k">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="nv">`u2`</span><span class="o">@</span><span class="nv">`%`</span>      <span class="o">|</span>
<span class="o">|</span> <span class="k">GRANT</span> <span class="k">SELECT</span> <span class="k">ON</span> <span class="nv">`db1`</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="nv">`u2`</span><span class="o">@</span><span class="nv">`%`</span> <span class="o">|</span>
<span class="o">|</span> <span class="k">GRANT</span> <span class="k">SELECT</span> <span class="k">ON</span> <span class="nv">`db2`</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="nv">`u2`</span><span class="o">@</span><span class="nv">`%`</span> <span class="o">|</span>
<span class="o">|</span> <span class="k">GRANT</span> <span class="nv">`u1`</span><span class="o">@</span><span class="nv">`%`</span><span class="p">,</span><span class="nv">`r1`</span><span class="o">@</span><span class="nv">`%`</span> <span class="k">TO</span> <span class="nv">`u2`</span><span class="o">@</span><span class="nv">`%`</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">-------------------------------------+</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SHOW</span> <span class="n">GRANTS</span> <span class="k">FOR</span> <span class="s1">'r2'</span> <span class="k">USING</span> <span class="s1">'u1'</span><span class="p">,</span> <span class="s1">'r1'</span><span class="p">;</span>
<span class="o">+</span><span class="c1">-------------------------------------+</span>
<span class="o">|</span> <span class="n">Grants</span> <span class="k">for</span> <span class="n">r2</span><span class="o">@%</span>                     <span class="o">|</span>
<span class="o">+</span><span class="c1">-------------------------------------+</span>
<span class="o">|</span> <span class="k">GRANT</span> <span class="k">USAGE</span> <span class="k">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="nv">`r2`</span><span class="o">@</span><span class="nv">`%`</span>      <span class="o">|</span>
<span class="o">|</span> <span class="k">GRANT</span> <span class="k">SELECT</span> <span class="k">ON</span> <span class="nv">`db1`</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="nv">`r2`</span><span class="o">@</span><span class="nv">`%`</span> <span class="o">|</span>
<span class="o">|</span> <span class="k">GRANT</span> <span class="k">SELECT</span> <span class="k">ON</span> <span class="nv">`db2`</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="nv">`r2`</span><span class="o">@</span><span class="nv">`%`</span> <span class="o">|</span>
<span class="o">|</span> <span class="k">GRANT</span> <span class="nv">`u1`</span><span class="o">@</span><span class="nv">`%`</span><span class="p">,</span><span class="nv">`r1`</span><span class="o">@</span><span class="nv">`%`</span> <span class="k">TO</span> <span class="nv">`r2`</span><span class="o">@</span><span class="nv">`%`</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">-------------------------------------+</span>
</code></pre></div></div>

<p>角色与用户的互换是有实际应用价值的：如某个项目一开始没有使用角色，而是为每个用户直接分配权限。如果某个程序员离职，解决办法：</p>

<ul>
  <li>不使用角色：修改帐户密码，交给新程序员使用</li>
  <li>使用角色：锁定原帐户，把该帐户分配给其它帐户</li>
</ul>

<h2 id="系统保留的帐户">系统保留的帐户</h2>

<p>MySQL 的安装过程包含对数据目录的初始化，期间会自动创建一些系统保留的用户帐户：</p>

<ul>
  <li><code class="highlighter-rouge">'root'@'localhost'</code> ：用于系统管理。该帐户拥有所有权限，可以进行任何操作。严格来讲，该帐户的用户名不是保留的，因此有些安装过程会把 root 重命名为其它，以规避风险。</li>
  <li><code class="highlighter-rouge">'mysql.sys'@'localhost'</code> ：用作 <code class="highlighter-rouge">sys</code> 表中对象的 <code class="highlighter-rouge">DEFINER</code>，使用 <code class="highlighter-rouge">mysql.sys</code> 帐户可以避免由 DBA 重命名或删除 root 帐户所带来的问题。该帐户是锁定的，无法用于客户端连接。</li>
  <li><code class="highlighter-rouge">'mysql.session'@'localhost'</code> ：各种插件用该帐户来访问服务端，该帐户是锁定的，无法用于客户端连接。</li>
  <li><code class="highlighter-rouge">'mysql.infoschema'@'localhost'</code> ：用作 <code class="highlighter-rouge">INFORMATION_SCHEMA</code> 视图的 <code class="highlighter-rouge">DEFINER</code>。使用 <code class="highlighter-rouge">mysql.infoschema</code> 帐户可以避免由 DBA 重命名或删除 root 帐户所带来的问题。该帐户是锁定的，无法用于客户端连接。</li>
</ul>

<h2 id="限定帐户资源">限定帐户资源</h2>

<p>可以通过把系统变量 <code class="highlighter-rouge">max_user_connections</code> 设为非 0 的值来限制客户端对服务端资源的使用。该变量会限制所有帐户产生的并发连接数，但对于客户端连接之后能做什么没有限制。</p>

<p>对于单个帐户对服务端资源的使用，MySQL 会进行以下限制：</p>

<ul>
  <li><code class="highlighter-rouge">MAX_QUERIES_PER_HOUR</code> ：每小时内每帐户可 <strong>查询</strong> 的次数</li>
  <li><code class="highlighter-rouge">MAX_UPDATES_PER_HOUR</code> ：每小时内每帐户可 <strong>更新</strong> 的次数</li>
  <li><code class="highlighter-rouge">MAX_CONNECTIONS_PER_HOUR</code> ：每小时内每帐户可 <strong>连接</strong> 到服务端的 <strong>次数</strong></li>
  <li><code class="highlighter-rouge">MAX_USER_CONNECTIONS</code> ：每帐户 <strong>连接</strong> 到服务端的 <strong>并发数</strong></li>
</ul>

<p>如果 <code class="highlighter-rouge">MAX_USER_CONNECTIONS</code> 为 0，则由全局变量 <code class="highlighter-rouge">max_user_connections</code> 决定，如果它也为 0，则表示不做限制。</p>

<p>客户端使用的每条语句都会算到查询限制中，只有对数据库或表进行修改的语句才算到更新限制中。</p>

<p>此处的帐户对应于 <code class="highlighter-rouge">mysql.user</code> 表中的一行。因此，对每个连接的评估，是基于 <code class="highlighter-rouge">user</code> 表中匹配的行。</p>

<p>假如某一行的值为 <code class="highlighter-rouge">'usera'</code> 及 <code class="highlighter-rouge">'%.example.com'</code>，服务端就会针对所有来自该域名的主机、使用该用户名的连接，单独进行资源的限定。</p>

<h4 id="创建帐户时指定资源限定">创建帐户时指定资源限定</h4>

<p><code class="highlighter-rouge">CREATE USER ... WITH ...</code></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'francis'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'frank'</span>
    <span class="o">-&gt;</span>     <span class="k">WITH</span> <span class="n">MAX_QUERIES_PER_HOUR</span> <span class="mi">20</span>
    <span class="o">-&gt;</span>          <span class="n">MAX_UPDATES_PER_HOUR</span> <span class="mi">10</span>
    <span class="o">-&gt;</span>          <span class="n">MAX_CONNECTIONS_PER_HOUR</span> <span class="mi">5</span>
    <span class="o">-&gt;</span>          <span class="n">MAX_USER_CONNECTIONS</span> <span class="mi">2</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="为现有帐户指定资源限定">为现有帐户指定资源限定</h4>

<p><code class="highlighter-rouge">ALTER USER ... WITH ...</code></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">ALTER</span> <span class="k">USER</span> <span class="s1">'francis'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="k">WITH</span> <span class="n">MAX_QUERIES_PER_HOUR</span> <span class="mi">100</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="限定参数的保存">限定参数的保存</h4>

<p>服务端把帐户的资源限定的参数保存在 <code class="highlighter-rouge">user</code> 表中，字段分别为 <code class="highlighter-rouge">max_questions</code>、<code class="highlighter-rouge">max_updates</code>、<code class="highlighter-rouge">max_connections</code>、<code class="highlighter-rouge">max_user_connections</code>。</p>

<p>对于每一字段来说，只有在它不为 0 时才会开始计数。</p>

<h4 id="资源使用的计算">资源使用的计算</h4>

<p>服务端运行期间，它会为每个帐户计算其资源的使用，如果该帐户的每小时连接数达到了限制值，服务端会拒绝该帐户的新的连接，直到一小时结束。</p>

<p>对资源使用的计数是基于帐户的，而不是基于客户端。</p>

<p>如果一个帐户每小时查询限制为 50 次，该帐户若同时连接了多个客户端，则这些客户端的查询次数统统要计算到这 50 次中。</p>

<h4 id="重置计数器">重置计数器</h4>

<p>资源使用的计数器随时可以被重置，即清零，可以全局统一重置，也可以针对个别帐户：</p>

<p>服务端每次重启时，所有计数器均为重置。</p>

<h5 id="为所有帐户重置计数器">为所有帐户重置计数器</h5>

<ul>
  <li>使用 <code class="highlighter-rouge">FLUSH USER_RESOURCES</code> 语句</li>
  <li>重新加载授权表也可以达到清零的目的：<code class="highlighter-rouge">FLUSH PRIVILEGES</code> 或 <code class="highlighter-rouge">mysqladmin reload</code></li>
</ul>

<h5 id="为特定帐户重置计数器">为特定帐户重置计数器</h5>

<p>要想为某一帐户重置计数器，可以通过重新设置变量来实现，变量值仍用原来的即可。</p>

<p>对于 <code class="highlighter-rouge">MAX_USER_CONNECTIONS</code> 限制，有可能会发生这样一种边缘案例：</p>

<p>如果该帐户当前已经达到最大连接数，其中的某一个连接中断，如果紧接着就有一个连接发起，会导致错误 <code class="highlighter-rouge">ER_TOO_MANY_USER_CONNECTIONS</code> 或 <code class="highlighter-rouge">ER_USER_LIMIT_REACHED</code>，因为服务端还没有完全处理完上一个连接的中断，只有在处理完上一个中断之后，服务端才会允许下一个连接。</p>

<h2 id="设置帐户密码">设置帐户密码</h2>

<p>MySQL 用户的密码保存在系统数据库 <code class="highlighter-rouge">mysql</code> 的 <code class="highlighter-rouge">user</code> 表中。</p>

<p>因此：</p>

<ul>
  <li>具有 <code class="highlighter-rouge">CREATE USER</code> 权限的用户才有权设定密码、修改密码。</li>
  <li>或者，如果对 <code class="highlighter-rouge">mysql</code> 数据库有操作权限，也可以设定密码、修改密码。<code class="highlighter-rouge">INSERT</code> 权限用于创建新帐户，<code class="highlighter-rouge">UPDATE</code> 权限用于修改现有帐户。</li>
  <li>如果启用了系统变量 <code class="highlighter-rouge">read_only</code>，在使用 <code class="highlighter-rouge">CREATE USER</code> 或 <code class="highlighter-rouge">ALTER USER</code> 语句时，额外还需要 <code class="highlighter-rouge">CONNECTION_ADMIN</code> 或 <code class="highlighter-rouge">SUPER</code> 权限。</li>
</ul>

<p>MySQL 使用插件进行用户身份的验证，在使用设定密码的语句时，验证插件会对明文密码进行任何需要的哈希操作，以便在将密码保存进 <code class="highlighter-rouge">mysql.user</code> 表之前，将其加密。</p>

<h4 id="新建帐户时指定密码">新建帐户时指定密码</h4>

<p>语法：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">USER</span> <span class="p">...</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'password'</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="为现有帐户修改密码">为现有帐户修改密码</h4>

<p>语法：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">USER</span> <span class="p">...</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'password'</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="为自己修改密码">为自己修改密码</h4>

<p>语法：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">USER</span> <span class="k">USER</span><span class="p">()</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'password'</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="从命令行修改密码">从命令行修改密码</h4>

<p>语法：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mysqladmin <span class="nt">-u</span> user_name <span class="nt">-h</span> host_name password <span class="s2">"password"</span><span class="p">;</span>
</code></pre></div></div>

<p>用 <code class="highlighter-rouge">mysqladmin</code> 在命令行修改密码不够安全，因为密码是做为命令的参数以明文的形式输入的。会被 <code class="highlighter-rouge">ps</code> 等命令显示出来。</p>

<h2 id="密码管理">密码管理</h2>

<p>MySQL 的密码管理包括：</p>

<ul>
  <li>密码过期：密码需要定期修改</li>
  <li>密码重用限制：用过的密码一定时间内不能再次使用</li>
  <li>密码强度：密码要足够复杂</li>
</ul>

<p>关于密码重用的限制，MySQL 除了要使用 <code class="highlighter-rouge">mysql.user</code> 表外，从 MySQL 8.0.3 版本开始，还要使用 <code class="highlighter-rouge">mysql.password_history</code> 这个系统表，如果从较低版本更新过来，必须要对这个修改做出适当的调整，否则，服务端会报错：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">ERROR</span><span class="p">]</span> <span class="k">Column</span> <span class="k">count</span> <span class="k">of</span> <span class="n">mysql</span><span class="p">.</span><span class="k">user</span> <span class="k">is</span> <span class="n">wrong</span><span class="p">.</span> <span class="n">Expected</span>
<span class="mi">49</span><span class="p">,</span> <span class="k">found</span> <span class="mi">47</span><span class="p">.</span> <span class="n">The</span> <span class="k">table</span> <span class="k">is</span> <span class="n">probably</span> <span class="n">corrupted</span>
<span class="p">[</span><span class="n">Warning</span><span class="p">]</span> <span class="n">ACL</span> <span class="k">table</span> <span class="n">mysql</span><span class="p">.</span><span class="n">password_history</span> <span class="n">missing</span><span class="p">.</span>
<span class="k">Some</span> <span class="n">operations</span> <span class="n">may</span> <span class="n">fail</span><span class="p">.</span>
</code></pre></div></div>

<p>要解决该问题，需要运行 <code class="highlighter-rouge">mysql_upgrade</code> 之后再重启服务端，在这之后才可以成功地修改密码。</p>

<h3 id="密码过期策略">密码过期策略</h3>

<p>MySQL 允许管理员手动设置帐户过期，并制定一个密码自动过期的策略。可以制定全局过期策略，也可只针对某个帐户。这些策略适用于使用内建验证插件的帐户，对于使用外部验证插件的帐户，密码过期策略同样也需要由外部系统来处理。</p>

<p>由策略决定的密码过期是基于密码的使用时间自动判断的，对于给定的帐户, 是从其最近一次修改密码的时间开始进行计算的。<code class="highlighter-rouge">mysql.user</code> 表会体现出每个帐户最近修改密码的时间，如果密码时间超过规定的时间，在客户端连接时，服务端会自动以密码过期来对待。</p>

<h4 id="服务端对密码过期的验证">服务端对密码过期的验证</h4>

<p>客户端成功连接到服务端以后，服务端会判断该帐户密码是否过期：</p>

<ul>
  <li>服务端首先检查帐户是否被手动设置为过期</li>
  <li>如果没有，再检查密码使用累积时间是否超过策略的规定，如果超过，认为其密码过期</li>
</ul>

<p>如果密码过期，无论手动还是自动的，服务端要么会断开客户端的连接，要么会限制其操作。被限制操作的客户端会收到要求修改密码的提示消息，直到其修改密码。</p>

<p>客户端重置密码后，服务端会为当前会话恢复其正常的访问，该帐户随后的连接也可成功。</p>

<p>如果是由管理员为用户重置的密码，当前现有的受限会话将保持受限，使用该帐户连接的客户端必须断开后重新连接。</p>

<p class="notice">虽然可以做到把密码重置为上一个密码，但做为一个好的密码策略，仍然建议选择一个不同的密码。DBA 可以通过建立适当的密码重用策略，来强制拒绝密码的重用。</p>

<h4 id="手动设置用户密码过期">手动设置用户密码过期</h4>

<p>使用 <code class="highlighter-rouge">ALTER USER</code> 语句来手动将帐户设置为密码过期：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">USER</span> <span class="s1">'jeffrey'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">PASSWORD</span> <span class="n">EXPIRE</span><span class="p">;</span>
</code></pre></div></div>

<p>该操作会在 <code class="highlighter-rouge">mysql.user</code> 表中的对应行中，将密码标记为过期。</p>

<h4 id="设置全局密码有效期">设置全局密码有效期</h4>

<p>要想制定全局的密码自动过期策略，需使用系统变量 <code class="highlighter-rouge">default_password_lifetime</code>，其默认值为 0，即禁用密码自动过期。如果变量值为正整数 N，则代表密码有效期为 N 天。</p>

<h5 id="配置文件">配置文件</h5>

<p>通过修改配置文件 <code class="highlighter-rouge">my.cnf</code> 来设置全局的密码有效期。</p>

<p>设置有效期为 180 天：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>mysqld]
<span class="nv">default_password_lifetime</span><span class="o">=</span>180
</code></pre></div></div>

<p>设置密码永不过期：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>mysqld]
<span class="nv">default_password_lifetime</span><span class="o">=</span>0
</code></pre></div></div>

<h5 id="运行时修改全局密码过期策略">运行时修改全局密码过期策略</h5>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SET</span> <span class="n">PERSIST</span> <span class="n">default_password_lifetime</span> <span class="o">=</span> <span class="mi">180</span><span class="p">;</span>
<span class="k">SET</span> <span class="n">PERSIST</span> <span class="n">default_password_lifetime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div></div>

<p>该语句设置的变量值，在服务端重启后依然会保存下来。</p>

<h4 id="为特定帐户设定密码有效期">为特定帐户设定密码有效期</h4>

<h5 id="新建用户时指定">新建用户时指定</h5>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'jeffrey'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">PASSWORD</span> <span class="n">EXPIRE</span> <span class="n">INTERVAL</span> <span class="mi">90</span> <span class="k">DAY</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'jeffrey'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">PASSWORD</span> <span class="n">EXPIRE</span> <span class="n">NEVER</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'jeffrey'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">PASSWORD</span> <span class="n">EXPIRE</span> <span class="k">DEFAULT</span><span class="p">;</span>
</code></pre></div></div>

<h5 id="修改现有用户">修改现有用户</h5>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">USER</span> <span class="s1">'jeffrey'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">PASSWORD</span> <span class="n">EXPIRE</span> <span class="n">INTERVAL</span> <span class="mi">90</span> <span class="k">DAY</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">USER</span> <span class="s1">'jeffrey'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">PASSWORD</span> <span class="n">EXPIRE</span> <span class="n">NEVER</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">USER</span> <span class="s1">'jeffrey'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">PASSWORD</span> <span class="n">EXPIRE</span> <span class="k">DEFAULT</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="密码重用策略">密码重用策略</h3>

<p>MySQL 允许对密码重用进行限制，该限制可以基于修改密码的次数、经历的时间、或二者兼有。既可以建立全局的限制策略，也可只针对特定帐户。</p>

<p>这些限制只对那些使用内建验证插件的帐户生效，对于使用外部验证插件的帐户来说，重用限制也需要外部系统来实现。</p>

<p>帐户的密码历史包含了他过去使用过的密码，MySQL 可以对旧密码的重新使用做出限制：</p>

<ul>
  <li>如果限制是基于修改密码次数，则必须使用过几次不同的新密码以后，才能重用旧密码。</li>
  <li>如果限制是基于逝去的时间，设置某密码后，必须经过 N 天才能重用</li>
</ul>

<p class="notice">空密码不会算在密码历史中，可以随时重用。</p>

<h4 id="配置全局密码重用策略">配置全局密码重用策略</h4>

<p>要想制定密码重用的策略，可使用系统变量 <code class="highlighter-rouge">password_history</code> 和 <code class="highlighter-rouge">password_reuse_interval</code>，这些变量可以在配置文件 <code class="highlighter-rouge">my.cnf</code> 中定义。</p>

<h5 id="在配置文件中定义">在配置文件中定义</h5>

<p>禁用最近使用的 6 个密码，密码超过 365 天才能重用：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>mysqld]
<span class="nv">password_history</span><span class="o">=</span>6
<span class="nv">password_reuse_interval</span><span class="o">=</span>365
</code></pre></div></div>

<h5 id="在运行时定义">在运行时定义</h5>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SET</span> <span class="n">PERSIST</span> <span class="n">password_history</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="k">SET</span> <span class="n">PERSIST</span> <span class="n">password_reuse_interval</span> <span class="o">=</span> <span class="mi">365</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="为特定帐户设置密码重用策略">为特定帐户设置密码重用策略</h4>

<p>要想为特定帐户设置密码重用策略，可以使用 <code class="highlighter-rouge">CREATE USER ... PASSWORD HISTORY</code> 或 <code class="highlighter-rouge">ALTER USER ... PASSWORD HISTORY</code>。</p>

<h5 id="新建帐户时指定">新建帐户时指定</h5>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'jeffrey'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">PASSWORD</span> <span class="n">HISTORY</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'jeffrey'</span><span class="o">@</span><span class="s1">'localhost'</span>
  <span class="n">PASSWORD</span> <span class="n">HISTORY</span> <span class="mi">5</span>
  <span class="n">PASSWORD</span> <span class="n">REUSE</span> <span class="n">INTERVAL</span> <span class="mi">365</span> <span class="k">DAY</span><span class="p">;</span>
</code></pre></div></div>

<h5 id="为现有帐户指定">为现有帐户指定</h5>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">USER</span> <span class="s1">'jeffrey'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">PASSWORD</span> <span class="n">HISTORY</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">USER</span> <span class="s1">'jeffrey'</span><span class="o">@</span><span class="s1">'localhost'</span>
  <span class="n">PASSWORD</span> <span class="n">HISTORY</span> <span class="mi">5</span>
  <span class="n">PASSWORD</span> <span class="n">REUSE</span> <span class="n">INTERVAL</span> <span class="mi">365</span> <span class="k">DAY</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="服务端对密码过期的处理">服务端对密码过期的处理</h2>

<p>MySQL 提供的密码过期功能，可以让管理员强制用户重置密码，也可以基于策略自动管理密码的过期。</p>

<p>对于使用已过期的帐户的连接，服务端要么会断开客户端，要么会将其限制于沙盒模式，期间服务端只允许该客户端进行与重置密码相关的操作。</p>

<h4 id="断开客户端">断开客户端</h4>

<p>服务端断开客户端时，会返回 <code class="highlighter-rouge">ER_MUST_CHANGE_PASSWORD_LOGIN</code> 的错误消息：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>shell&gt; mysql <span class="nt">-u</span> myuser <span class="nt">-p</span>
Password: <span class="k">******</span>
ERROR 1862 <span class="o">(</span>HY000<span class="o">)</span>: Your password has expired. To log <span class="k">in </span>you must
change it using a client that supports expired passwords.
</code></pre></div></div>

<h4 id="将客户端限制于沙盒">将客户端限制于沙盒</h4>

<p>如果服务端把客户端限制在沙盒模式，允许客户端进行以下操作：</p>

<ul>
  <li>客户端可使用 <code class="highlighter-rouge">ALTER USER</code> 或 <code class="highlighter-rouge">SET PASSWORD</code> 语句来重置密码。重置之后，服务端会为该会话恢复正常的访问，该帐户之后的连接也恢复正常。</li>
  <li>客户端可使用 <code class="highlighter-rouge">SET</code> 语句</li>
</ul>

<h4 id="非交互式客户端">非交互式客户端</h4>

<p>对于非交互式 mysql 客户端的调用，如批处理模式，密码过期时，服务端通常会断开客户端的连接。要想保持连接，以便有机会重置密码，应使用 <code class="highlighter-rouge">--connect-expired-password</code> 选项。</p>

<h4 id="服务端处理密码过期客户端的流程">服务端处理密码过期客户端的流程</h4>

<p>对于密码过期的客户端，服务端会断开其连接，还是将其置于沙盒中，这取决于客户端和服务端设置的组合。</p>

<h5 id="客户端的配置">客户端的配置</h5>

<p>在客户端，一个给定的客户端会表明它是否能为密码过期而接受沙盒模式。对于使用 C 运行库的客户端来说，有两个方法来决定：</p>

<ul>
  <li>在连接之前，把 <code class="highlighter-rouge">MYSQL_OPT_CAN_HANDLE_EXPIRED_PASSWORDS</code> 标签传递给 <code class="highlighter-rouge">mysql_options()</code>：</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>arg <span class="o">=</span> 1<span class="p">;</span>
result <span class="o">=</span> mysql_options<span class="o">(</span>mysql,
                       MYSQL_OPT_CAN_HANDLE_EXPIRED_PASSWORDS,
                       &amp;arg<span class="o">)</span><span class="p">;</span>
</code></pre></div></div>

<p>如果以交互方式调用，或启用了 <code class="highlighter-rouge">--connect-expired-password</code> 选项，mysql 客户端就会启用 <code class="highlighter-rouge">MYSQL_OPT_CAN_HANDLE_EXPIRED_PASSWORDS</code>。</p>

<ul>
  <li>连接时，把 <code class="highlighter-rouge">CLIENT_CAN_HANDLE_EXPIRED_PASSWORDS</code> 标签传递给 <code class="highlighter-rouge">mysql_real_connect()</code>：</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql <span class="o">=</span> mysql_real_connect<span class="o">(</span>mysql,
                           host, user, password, db,
                           port, unix_socket,
                           CLIENT_CAN_HANDLE_EXPIRED_PASSWORDS<span class="o">)</span><span class="p">;</span>
</code></pre></div></div>

<p>其它的 MySQL 连接器有其自己的方法来表示是否可接受沙盒模式。</p>

<h5 id="服务端配置">服务端配置</h5>

<p>在服务端，如果客户端表示它可以处理密码过期，服务端就将其置于沙盒模式。</p>

<p>如果客户端没有表示它能够处理密码过期，服务端的行为取决于系统变量 <code class="highlighter-rouge">disconnect_on_expired_password</code> 的值：</p>

<ul>
  <li>如果启用了 <code class="highlighter-rouge">disconnect_on_expired_password</code> 变量（默认值），服务端会断开客户端，返回 <code class="highlighter-rouge">ER_MUST_CHANGE_PASSWORD_LOGIN</code> 错误消息</li>
  <li>如果禁用了 <code class="highlighter-rouge">disconnect_on_expired_password</code> 变量，服务端将客户端置于沙盒模式。</li>
</ul>

<h2 id="用插件验证身份">用插件验证身份</h2>

<p>客户端连接到服务端时，服务端使用用户名和客户端主机来匹配 <code class="highlighter-rouge">mysql.user</code> 系统表，然后根据匹配行来决定用哪个验证插件对客户端进行验证：</p>

<ul>
  <li>如果服务端找不到插件，返回错误消息，拒绝连接</li>
  <li>如果找到插件，服务端会调用该插件来验证用户，插件返回状态码，以表明用户是否验证通过</li>
</ul>

<p>使用插件进行验证启用了以下功能：</p>

<ul>
  <li>验证方法可以有所选择：对单独帐户可以选择不同的验证方法</li>
  <li>外部验证：可以把密码保存在外部，而不是 <code class="highlighter-rouge">mysql.user</code> 系统表中</li>
  <li>代理用户：一个用户代替另一个用户连接到服务端，享有另一用户的权限</li>
</ul>

<p class="notice">启动服务端时如果使用 <code class="highlighter-rouge">--skip-grant-tables</code> 选项，就不会使用验证插件了，此时服务端对客户端不会进行验证，允许任何客户端连接进来。这样做非常不安全，因此，当服务端用 <code class="highlighter-rouge">--skip-grant-tables</code> 选项启动时，它会自动启用 <code class="highlighter-rouge">--skip-networking</code>，自动禁止远程连接。</p>

<h3 id="可用的验证插件">可用的验证插件</h3>

<p>MySQL 8.0 提供以下验证插件：</p>

<h4 id="本机插件">本机插件</h4>

<p><code class="highlighter-rouge">mysql_native_password</code> 可进行本机验证。验证是基于对密码的哈希处理。</p>

<h4 id="sha-插件">SHA 插件</h4>

<p>使用 SHA-256 密码哈希，比本机验证使用更强的加密方法。</p>

<h4 id="客户端明文插件">客户端明文插件</h4>

<p>客户端插件，把密码以明文方式发送给服务端，通常与需要访问明文密码的服务端插件配合使用。</p>

<h4 id="pam-插件">PAM 插件</h4>

<p>该插件使用 PAM 对用户进行外部验证。支持代理用户。</p>

<h4 id="ldap-插件">LDAP 插件</h4>

<p>LDAP，Lightweight Directory Access Protocol</p>

<p>通过访问目录服务，使用 LDAP 对用户进行验证。</p>

<h4 id="非登陆插件">非登陆插件</h4>

<p>使用该插件的帐户，会被禁止从客户端连接。该插件的使用场景包括：</p>

<ul>
  <li>有些帐户是不允许直接登陆的，必须通过代理帐户才能登陆</li>
  <li>有些帐户必须有高级权，来执行存储程序和视图，这些权限不能暴露给普通用户</li>
</ul>

<h4 id="套接字连接插件">套接字连接插件</h4>

<p>对那些从本地主机，通过套接字文件连接进来的帐户进行验证。</p>

<h4 id="测试插件">测试插件</h4>

<p>验证帐户密码，并将验证结果写入服务端错误日志。该插件主要用于测试和开发。</p>

<h3 id="验证插件的使用方法">验证插件的使用方法</h3>

<p>通常来说，插件式的验证会使用服务端和客户端的一对相应的插件。主要用法：</p>

<p>如有必要，应该安装含有插件的运行库。在服务端主机上，安装含有服务端插件的运行库，这样服务端才能用来对连接进行验证。类似地，在每个客户端主机上，也要安装包含客户端插件的运行库。内建的插件无需安装。</p>

<p>对于创建的每个 MySQL 帐户，可以为其指定适当的服务端验证插件。如果帐户要使用默认的验证插件，就无需在帐户创建的语句中指定。系统变量 <code class="highlighter-rouge">default_authentication_plugin</code> 用于配置默认的验证插件。</p>

<p>客户端连接时，服务端插件会告诉客户端程序使用哪个客户端的插件来验证。</p>

<p>如果某个帐户使用的验证方法均是服务端和客户端程序默认的，则服务端无需与客户端通信来确定要用哪个插件，客户端与服务端的协商可以免去。</p>

<p>对于像 <code class="highlighter-rouge">mysql</code> 和 <code class="highlighter-rouge">mysqladmin</code> 这样的客户端来说，在命令行中可以指定 <code class="highlighter-rouge">--default-auth=plugin_name</code> 选项，来告诉服务端它要使用的插件。但是，如果与该帐户关联的验证插件是另一个，服务端就会覆盖该选项。</p>

<p>如果客户端程序没有找到客户端插件运行库文件，可以用 <code class="highlighter-rouge">--plugin-dir=dir_name</code> 选项来指定插件运行库目录的位置。</p>

<h3 id="验证插件对客户端和服务端的兼容性">验证插件对客户端和服务端的兼容性</h3>

<p>插件式的验证允许 MySQL 帐户灵活选择验证方法，但在某些情况下，如果验证插件在客户端和服务端之间无法兼容，客户端就无法建立连接。</p>

<p>通常的兼容规则是，客户端和服务端都要支持该帐户指定的验证方法，因为验证方法是由插件来实现的，双方必须同时支持该插件。</p>

<p>很多情况会造成验证插件的不兼容，要么只有一方识别该插件，要么是一方无权限访问插件。总之，如果双方的 MySQL 是同一发行版，同一版本，通常就不会有兼容的问题。</p>

<h2 id="代理用户">代理用户</h2>

<p>对给定连接进行身份验证的插件，可能要求将连接 (外部) 用户视为不同的用户，以便进行权限检查。于是可以把外部用户做为第二用户的代理，享受第二用户的权限：</p>

<ul>
  <li>外部用户是一个 <strong>代理用户</strong>，可以冒充别的用户</li>
  <li>第二用户是一个 <strong>被代理的用户</strong>，其身份和权限可以由代理用户承担</li>
</ul>

<h3 id="实现用户代理的条件">实现用户代理的条件</h3>

<p>要想针对特定的验证插件进行用户代理，需要满足以下条件：</p>

<ul>
  <li>必须支持代理，要么由插件自身支持，可么由 MySQL 服务端代表插件提供支持。对于后者，需要显式启用。</li>
  <li>代理的用户帐户必须设置为由特定插件验证，<code class="highlighter-rouge">CREATE USER</code> 或 <code class="highlighter-rouge">ALTER USER</code> 语句中可指定。</li>
  <li>被代理的用户帐户创建后，必须授予需要代理用户承担的权限，用 <code class="highlighter-rouge">CREATE USER</code> 和 <code class="highlighter-rouge">GRANT</code> 语句。</li>
  <li>代理用户帐户对于被代理的帐户必须有 <code class="highlighter-rouge">RPOXY</code> 权限，用 <code class="highlighter-rouge">GRANT</code> 语句。</li>
  <li>要想让连接到代理帐户的客户端能被作为代理用户对待，验证插件必须返回一个与客户端用户不同的用户名，即被代理的用户名。对于服务端，被代理的用户决定于有 <code class="highlighter-rouge">PROXY</code> 权限的用户。</li>
</ul>

<p>代理机制只允许把客户端用户名映射到被代理的用户名，不支持代理主机名。当匹配代理帐户的客户端连接时，服务端尝试用该用户名查找匹配的被代理帐户。</p>

<h4 id="范例-1">范例</h4>

<p>当客户端以用户 <code class="highlighter-rouge">employee_ext</code> 的身份从本地主机连接到服务端时，MySQL 使用名为 <code class="highlighter-rouge">my_auth_plugin</code> 的插件来验证。</p>

<p>基于 <code class="highlighter-rouge">'my_auth_string'</code> 的内容，还有可能会查询一些外部的验证系统，之后，该插件会返回一个用户名 <code class="highlighter-rouge">employee</code> 给服务端。返回的 <code class="highlighter-rouge">employee</code> 是为了作为本地用户检查其权限。</p>

<p>因此，<code class="highlighter-rouge">employee_ext</code> 是代理用户， <code class="highlighter-rouge">employee</code> 是被代理用户。</p>

<p>服务端会检查 <code class="highlighter-rouge">employee_ext</code> 用户对 <code class="highlighter-rouge">employee</code> 用户是否有 <code class="highlighter-rouge">PROXY</code> 权限，如果有，才能证明它有权代理。</p>

<p><code class="highlighter-rouge">employee_ext</code> 会享有 <code class="highlighter-rouge">employee</code> 的权限，客户端会话中，服务端会检查执行的语句，看是否属于 <code class="highlighter-rouge">employee</code> 权限范围。</p>

<p>于是，<code class="highlighter-rouge">employee_ext</code> 可以访问数据库 <code class="highlighter-rouge">employess</code> 中的表格了。</p>

<p>当代理发生时，<code class="highlighter-rouge">USER()</code> 和 <code class="highlighter-rouge">CURRENT_USER()</code> 函数可用于查看代理用户及被代理用户。</p>

<h5 id="创建代理帐户">创建代理帐户</h5>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'employee_ext'</span><span class="o">@</span><span class="s1">'localhost'</span>
  <span class="n">IDENTIFIED</span> <span class="k">WITH</span> <span class="n">my_auth_plugin</span> <span class="k">AS</span> <span class="s1">'my_auth_string'</span><span class="p">;</span>
</code></pre></div></div>

<p class="notice"><code class="highlighter-rouge">IDENTIFIED WITH</code> 子句后面跟的 <code class="highlighter-rouge">AS 'my_auth_string'</code> 子句，指定一个字符串，当该用户连接时，服务端会将该字符串传递给插件。根据每个插件的要求来确定是否需要使用 <code class="highlighter-rouge">AS</code> 子句，如果需要，字符串的格式取决于插件要如何使用它，具体格式查询插件文档。</p>

<h5 id="创建被代理帐户授予权限">创建被代理帐户，授予权限</h5>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'employee'</span><span class="o">@</span><span class="s1">'localhost'</span>
  <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'employee_pass'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">ON</span> <span class="n">employees</span><span class="p">.</span><span class="o">*</span>
  <span class="k">TO</span> <span class="s1">'employee'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">;</span>
</code></pre></div></div>

<h5 id="为代理用户授予代理权限">为代理用户授予代理权限</h5>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">GRANT</span> <span class="n">PROXY</span>
  <span class="k">ON</span> <span class="s1">'employee'</span><span class="o">@</span><span class="s1">'localhost'</span>
  <span class="k">TO</span> <span class="s1">'employee_ext'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="为代理授权">为代理授权</h3>

<p>MySQL 安装时初始化的 root 帐户对空帐户 <code class="highlighter-rouge">''@''</code> 有代理权，即它对任何用户、任何主机的帐户都有代理权。因此，root 也有能力授权其他的代理用户。</p>

<h4 id="代理授权">代理授权</h4>

<p>一个外部用户要想代理用户，需要有 <code class="highlighter-rouge">PROXY</code> 权限，用 <code class="highlighter-rouge">GRANT</code> 语句授权：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">GRANT</span> <span class="n">PROXY</span> <span class="k">ON</span> <span class="s1">'proxied_user'</span> <span class="k">TO</span> <span class="s1">'proxy_user'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="n">PROXY</span> <span class="k">ON</span> <span class="s1">'a'</span> <span class="k">TO</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">,</span> <span class="s1">'d'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="n">PROXY</span> <span class="k">ON</span> <span class="s1">'a'</span> <span class="k">TO</span> <span class="s1">'d'</span> <span class="k">WITH</span> <span class="k">GRANT</span> <span class="k">OPTION</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="n">PROXY</span> <span class="k">ON</span> <span class="s1">'a'</span> <span class="k">TO</span> <span class="s1">''</span><span class="o">@</span><span class="s1">''</span><span class="p">;</span>
</code></pre></div></div>

<p>该语句会在授权表 <code class="highlighter-rouge">mysql.proxies_priv</code> 中创建一条记录。</p>

<p>连接时，proxy_user 必须是一个验证通过的、有效的外部用户，proxied_user 则代表一个本地验证通过的、有效用户，否则连接会失败。</p>

<h4 id="撤消授权">撤消授权</h4>

<p>撤消代理使用 <code class="highlighter-rouge">REVOKE</code> 语句：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">REVOKE</span> <span class="n">PROXY</span> <span class="k">ON</span> <span class="s1">'proxied_user'</span> <span class="k">FROM</span> <span class="s1">'proxy_user'</span><span class="p">;</span>
<span class="k">REVOKE</span> <span class="n">PROXY</span> <span class="k">ON</span> <span class="s1">'a'</span> <span class="k">FROM</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">,</span> <span class="s1">'d'</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="默认的代理用户">默认的代理用户</h3>

<p>如果希望某些或全部用户使用特定的验证插件来连接，可以先创建一个 <strong>空帐户</strong> <code class="highlighter-rouge">''@''</code>，将其与插件关联，之后让插件返回真正的验证用户名。</p>

<p>如，假设名为 <code class="highlighter-rouge">ldap_auth</code> 的插件用于 LDAP 验证，它会把连接用户映射为程序员或经理的帐户：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- 创建默认代理帐户</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">''</span><span class="o">@</span><span class="s1">''</span> <span class="n">IDENTIFIED</span> <span class="k">WITH</span> <span class="n">ldap_auth</span> <span class="k">AS</span> <span class="s1">'O=Oracle, OU=MySQL'</span><span class="p">;</span>

<span class="c1">-- 创建被代理帐户</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'developer'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'developer_pass'</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'manager'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'manager_pass'</span><span class="p">;</span>

<span class="c1">-- 为默认代理帐户授予 PROXY 权限</span>
<span class="k">GRANT</span> <span class="n">PROXY</span> <span class="k">ON</span> <span class="s1">'manager'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="k">TO</span> <span class="s1">''</span><span class="o">@</span><span class="s1">''</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="n">PROXY</span> <span class="k">ON</span> <span class="s1">'developer'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="k">TO</span> <span class="s1">''</span><span class="o">@</span><span class="s1">''</span><span class="p">;</span>
</code></pre></div></div>

<p>如果有一个客户端要连接：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>shell&gt; mysql <span class="nt">--user</span><span class="o">=</span>myuser <span class="nt">--password</span> ...
Enter password: myuser_pass
</code></pre></div></div>

<p>服务端找不到 <code class="highlighter-rouge">myuser</code> 这个用户，但是可以用空帐户 <code class="highlighter-rouge">''@''</code> 来匹配，于是服务端将其验证为该帐户。服务端调用 <code class="highlighter-rouge">ldap_auth</code> 插件，将 <code class="highlighter-rouge">myuser</code> 和 <code class="highlighter-rouge">myuser_pass</code> 传递给它。</p>

<p>如果插件在 LDAP 目录中查找后，发现密码不正确，验证失败，拒绝连接。</p>

<p>如果密码正确，且插件发现 <code class="highlighter-rouge">myuser</code> 是个程序员，它会给服务端返回用户名 <code class="highlighter-rouge">developer</code>，而不是 <code class="highlighter-rouge">myuser</code> 。当服务端注意到，返回的用户名与客户端用户名不同时，它就明白，应该把 <code class="highlighter-rouge">myuser</code> 按代理用户对待。服务端在确认空帐户可以匹配为 <code class="highlighter-rouge">deleloper</code> 之后，接受连接。在该会话中，<code class="highlighter-rouge">myuser</code> 会拥有 <code class="highlighter-rouge">developer</code> 的权限。</p>

<p>如果插件在 LDAP 目录中查找后，发现 <code class="highlighter-rouge">myuser</code> 是个经理，它会给服务端返回用户名 <code class="highlighter-rouge">manager</code>，该会话中，<code class="highlighter-rouge">myuser</code> 就会拥有 <code class="highlighter-rouge">manager</code> 的权限。</p>

<p>为了简化使用，外部验证不能分多个等级，</p>

<h3 id="默认的代理用户与匿名帐户户的冲突">默认的代理用户与匿名帐户户的冲突</h3>

<p>若要创建一个默认代理用户，首先要查看现有的可以匹配任何用户的宽匹配帐户，它们会在匹配默认代理用户之前优先被匹配。</p>

<p>上例中的默认代理用户帐户为空帐户，其主机部分为空，可以匹配任何主机。在创建默认代理用户时，要仔细检查是否有匿名帐户存在，即 <code class="highlighter-rouge">''@'%'</code> ，该帐户会先于空帐户进行匹配。</p>

<p>遇到这种冲突的情况，有几个解决办法：</p>

<h4 id="删除匿名帐户">删除匿名帐户</h4>

<p>删除匿名帐户就没有了冲突。</p>

<h4 id="使用更具体的默认代理用户">使用更具体的默认代理用户</h4>

<p>如果使用更具体的默认代理用户，如 <code class="highlighter-rouge">''@'localhost'</code>，就可以先于匿名用户进行匹配，冲突就不复存在了。</p>

<p>使用该方法后，将无法从本地主机以匿名用户身份连接。</p>

<h4 id="创建多个代理用户">创建多个代理用户</h4>

<p>创建多个代理用户，一个用于本地连接，一个用于远程连接。该办法在本地用户需要不同权限时尤其适用。</p>

<h5 id="创建代理用户">创建代理用户：</h5>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- 用于本地连接的代理用户</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">''</span><span class="o">@</span><span class="s1">'localhost'</span>
  <span class="n">IDENTIFIED</span> <span class="k">WITH</span> <span class="n">some_plugin</span> <span class="k">AS</span> <span class="s1">'some_auth_string'</span><span class="p">;</span>
<span class="c1">-- 用于远程连接的代理用户</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">''</span><span class="o">@</span><span class="s1">'%'</span>
  <span class="n">IDENTIFIED</span> <span class="k">WITH</span> <span class="n">some_plugin</span> <span class="k">AS</span> <span class="s1">'some_auth_string'</span><span class="p">;</span>
</code></pre></div></div>

<h5 id="创建被代理用户">创建被代理用户：</h5>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- 为本地连接创建被代理用户</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'developer'</span><span class="o">@</span><span class="s1">'localhost'</span>
  <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'some_password'</span><span class="p">;</span>
<span class="c1">-- 为远程连接创建被代理用户</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'developer'</span><span class="o">@</span><span class="s1">'%'</span>
  <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'some_password'</span><span class="p">;</span>
</code></pre></div></div>

<h5 id="授予代理权限">授予代理权限</h5>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">GRANT</span> <span class="n">PROXY</span> <span class="k">ON</span> <span class="s1">'developer'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="k">TO</span> <span class="s1">''</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="n">PROXY</span> <span class="k">ON</span> <span class="s1">'developer'</span><span class="o">@</span><span class="s1">'%'</span> <span class="k">TO</span> <span class="s1">''</span><span class="o">@</span><span class="s1">'%'</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="服务端对代理用户映射的支持">服务端对代理用户映射的支持</h3>

<p>有些验证插件会自己进行代理用户的映射，如 PAM 等，其它插件默认不支持代理用户。有些插件如果被授予代理权限，可以请求服务端自己进行代理用户的映射，如 <code class="highlighter-rouge">mysql_native_password</code>、<code class="highlighter-rouge">sha256_password</code>。如果启用了系统变量 <code class="highlighter-rouge">check_proxy_users</code>，服务端会为任何提出请求的验证插件进行代理用户的映射：</p>

<p>默认情况下，<code class="highlighter-rouge">check_proxy_users</code> 是禁用的，因此服务端不会进行映射，不管这个请求是由什么插件提出的。</p>

<p>如果启用了 <code class="highlighter-rouge">check_proxy_users</code>，也应该同时启用各插件专用的系统变量，以便使用服务端对映射的支持：</p>

<ul>
  <li>对于 <code class="highlighter-rouge">mysql_native_password</code>  插件，需启用 <code class="highlighter-rouge">mysql_native_password_proxy_users</code> 变量</li>
  <li>对于 <code class="highlighter-rouge">sha256_password</code> 插件，需启用 <code class="highlighter-rouge">sha256_password_proxy_users</code> 变量</li>
</ul>

<p>服务端进行代理用户的映射时有如下限制：</p>

<ul>
  <li>服务端不会为匿名用户代理，也不会代理为匿名用户</li>
  <li>如果一个帐户被授权可以代理多个帐户，服务端的映射是不确定的。因此，不建议代理多个帐户。</li>
</ul>

<h3 id="代理用户的系统变量">代理用户的系统变量</h3>

<p>有两个系统变量可以帮助追踪代理的登陆过程：</p>

<h4 id="proxy_user"><code class="highlighter-rouge">proxy_user</code></h4>

<p>如果当前没有发生代理，该变量的值为 <code class="highlighter-rouge">NULL</code>，否则变量值为代理用户的帐户。</p>

<h4 id="external_user"><code class="highlighter-rouge">external_user</code></h4>

<p>有时验证插件会使用一个外部用户来验证，例如使用 windows 本机验证时，使用 windows API 的验证插件不需要知道登陆的 ID。但是，它会使用一个 windows 的用户来验证。插件可以使用只读会话变量 <code class="highlighter-rouge">external_user</code>，把外部用户的 ID 返回给服务端。如果插件没有为该变量赋值，其值为 <code class="highlighter-rouge">NULL</code>。</p>

<h2 id="锁定帐户">锁定帐户</h2>

<p>MySQL 支持锁定帐户和解锁帐户。通过在 <code class="highlighter-rouge">CREATE USER</code> 和 <code class="highlighter-rouge">ALTER USER</code> 中使用子句 <code class="highlighter-rouge">ACCOUNT LOCK</code> 或 <code class="highlighter-rouge">ACCOUNT UNLCOK</code> 。</p>

<p>帐户的锁定状态记录于 <code class="highlighter-rouge">mysql.user</code> 表中的 <code class="highlighter-rouge">account_locked</code> 字段，用 <code class="highlighter-rouge">SHOW CREATE USER</code> 可以查看该帐户是否锁定。</p>

<p>如果客户端尝试连接到一个锁定帐户，连接会失败。服务端会将状态变量 <code class="highlighter-rouge">Locked_connects</code> 加 1，并返回错误消息。</p>

<p>锁定一个帐户并不影响该帐户被代理，也不影响其执行存储程序和视图的能力。</p>

        
      </section>




      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
	<hr />
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> 标签: </strong>
    <span itemprop="keywords">
    
		
      <a href="/tag/mysql" class="page__taxonomy-item" rel="tag">mysql</a><span class="sep">  </span>
    
		
      <a href="/tag/帐户" class="page__taxonomy-item" rel="tag">帐户</a>
    
    </span>
  </p>













  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> 分类: </strong>
	<!--  <hr />    -->
    <span itemprop="keywords">
    
      
      
      <a href="http://localhost:4000/categories/#database" class="page__taxonomy-item" rel="tag">database</a>
    
    </span>
  </p>




        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 更新时间:</strong> <time datetime="2016-03-01T00:00:00+08:00">March 01, 2016</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">分享</h4>
  

  <a href="https://twitter.com/intent/tweet?via=liloli&text=MySQL+%E7%9A%84%E5%B8%90%E6%88%B7%E7%AE%A1%E7%90%86%20http%3A%2F%2Flocalhost%3A4000%2Fdatabase%2Fmysql_account_managemt%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="分享 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fdatabase%2Fmysql_account_managemt%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="分享 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http%3A%2F%2Flocalhost%3A4000%2Fdatabase%2Fmysql_account_managemt%2F" class="btn btn--google-plus" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="分享 Google Plus"><i class="fab fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fdatabase%2Fmysql_account_managemt%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="分享 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="http://localhost:4000/framework/lamp_intro/" class="pagination--pager" title="LAMP 架构工作原理
">向前</a>
    
    
      <a href="http://localhost:4000/database/mysql_backup/" class="pagination--pager" title="MySQL 的备份与恢复
">向后</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">猜您还喜欢</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/bash/time/" rel="permalink">Bash 脚本 - 时间
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/bash/storage/" rel="permalink">Bash 脚本 - 存储空间
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/bash/numbers/" rel="permalink">Bash 脚本 - 数字
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/bash/input/" rel="permalink">Bash 脚本 - 输入
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>
        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap">
  <input type="text" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  <div id="results" class="results"></div>
</div>
      </div>
    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->


<!-- end custom footer snippets -->

        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>关注:</strong></li>
    
    
      <li><a href="https://twitter.com/liloli"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
    
    
      <li><a href="https://www.facebook.com/lilolibj"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i> Facebook</a></li>
    
    
      <li><a href="https://github.com/liloli"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    
    <li><a href="http://localhost:4000/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2018 Hawk Zhang. 技术来自于 <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="http://localhost:4000/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>



  
  
  <script src="http://localhost:4000/assets/js/lunr/lunr.min.js"></script>
  <script src="http://localhost:4000/assets/js/lunr/lunr-store.js"></script>
  <script src="http://localhost:4000/assets/js/lunr/lunr-en.js"></script>





    
  <script>
    var disqus_config = function () {
      this.page.url = "http://localhost:4000/database/mysql_account_managemt/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/database/mysql_account_managemt"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://liloli.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  



  </body>
</html>
