---
toc: true
toc_label: "运维速查 - 网络"
toc_icon: "copy"
title: "运维速查 - 网络"
tags: 速查 网络
categories: "cheatsheet"
classes: wide
excerpt: "运维常见问题"
header:
  overlay_image: /assets/images/header/matrix2.jpg
  overlay_filter: rgba(0, 0, 0, 0.8)
---






## 系统设置




### 配置主机名


```bash
$ sudo nmcli general hostname hollyshit
$ sudo hostnamectl set-hostname hollyshit
```







### 配置 IP 地址

```bash
$ sudo vi /etc/sysconfig/network-scripts/ifcfg-ens33
```

```conf
IPADD=192.168.1.10
DNS=192.168.1.5
GATEWAY=192.168.1.1
NETMASK=255.255.255.0
ZONE=public
ONBOOT=yes
```

```bash
$ sudo systemctl restart network
```






### 修改 http 的最大并发请求数

通过修改该配置文件中的最大文件描述符数量实现，重启后生效。

```bash
$ cat /etc/security/limits.conf
soft nofile 10240
hard nofile 10240
```



### 路由设置

使用 `route` 来查看和管理 IP 路由表。


#### 添加主机路由

```bash
$ route add -host 192.168.197.100 dev etho
```


#### 添加默认网关

```bash
$ route add default gw 192.168.197.1
```


#### 添加网络路由

```bash
$ route add -net 192.168.1.0 netmask 255.255.255.0 dev eth1
$ route add -net 192.168.1.0 netmask 255.255.255.0 gw 192.168.197.1
```










## 网络检测



### 检查网络中哪些地址在线

192.168.1.0/24 网络中，哪些 IP 地址在线。

能 ping 通则认为在线，ping 的返回值为 0 则认为是通的。

```bash
#!/bin/bash
for ip in `seq 1 255`
do
  ping -c 1 192.168.1.$ip > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    echo 192.168.1.$ip UP
  else
    echo 192.168.1.$ip DOWN
  fi
done
wait
```
























## 网络监控



### 查看 http 的并发请求数与其 TCP 连接状态

```bash
$ ss -s
$ netstat -n | awk '/^tcp/{a[$NF]++} END{for(i in a){print i,a[i]}}'
```



### 查看哪个地址对 80 端口的访问次数最多

用 `tcpdump` 嗅探 80 端口的访问，看谁最高。

```bash
$ sudo tcpdump -i venet0 -tnn dst port 80 -c 1000 \
| awk '/^IP/{print $2}' \
| awk -F. '{print $1 "." $2 "." $3 "." $4}' \
| uniq -c \
| sort -rn
```



### 查看每个 ip 地址的连接数

```bash
$ netstat -n \
| awk '/^tcp/ {print $5}' \
| awk -F: '{print $1}' \
| sort \
| uniq -c \
| sort -rn
```
















## IPTABLES



### 端口转发

将对本地 80 端口的请求转发到本地 8080 端口，IP 地址为 10.0.0.254。

```bash
$ iptables -A PREROUTING -t nat \
	-p tcp -d 10.0.0.254 --dport 80 \
	-j DNAT --to-destination 10.0.0.254:8080
```


### 禁止特定 IP 地址访问

```
iptables -A INPUT -s 192.168.1.55 -j REJECT
```



### 日志报错

#### 症状：

服务器负载正常，但请求大量超时，服务器/应用访问日志看不到相关请求记录。

在 dmesg 或 /var/log/messages 看到大量以下记录：

`kernel: nf_conntrack: table full, dropping packet.`

#### 原因：

服务器访问量大，内核 netfilter 模块 conntrack 相关参数配置不合理，散列表被填满，导致 IP 数据包被丢弃，连接无法建立。

#### 解决：

* 关闭防火墙
* 将散列表扩容
* 修改规则，禁用一些不必要的追踪



### 查看连接追踪表信息

查看追踪表中所有条目：

```bash
$ sudo cat /proc/net/nf_conntrack
ipv4     2 tcp      6 299 ESTABLISHED src=192.168.1.6 dst=192.168.1.77 sport=11385 dport=22 src=192.168.1.77 dst=192.168.1.6 sport=22 dport=11385 [ASSURED] mark=0 secctx=system_u:object_r:unlabeled_t:s0 zone=0 use=2
ipv4     2 tcp      6 60 SYN_SENT src=192.168.1.77 dst=192.168.1.78 sport=60638 dport=3306 [UNREPLIED] src=192.168.1.78 dst=192.168.1.77 sport=3306 dport=60638 mark=0 secctx=system_u:object_r:unlabeled_t:s0 zone=0 use=2
```

查看条目总量上限：

```bash
$ sysctl net.netfilter.nf_conntrack_max
net.netfilter.nf_conntrack_max = 31248

$ cat /proc/sys/net/netfilter/nf_conntrack_max
31248
```

查看当前已有条目：

```bash
$ sysctl net.netfilter.nf_conntrack_count
net.netfilter.nf_conntrack_count = 3

$ cat /proc/sys/net/netfilter/nf_conntrack_count
3
```

查看追踪表大小：

```bash
$ sysctl net.netfilter.nf_conntrack_buckets
net.netfilter.nf_conntrack_buckets = 8192

$ cat /proc/sys/net/netfilter/nf_conntrack_buckets
8192
```

计算负载系数：

`Load Factor` = `nf_conntrack_count` / `nf_conntrack_buckets`

如果负载系数超过 0.67 就要考虑扩容追踪表了。








## FirewallD



#### 添加端口

```bash
$ sudo firewall-cmd --permanent --add-service=http
```






























































## 脚本




### 随机数



#### 在 6 ~ 9 范围内取随机数

```bash
$ echo `expr $[RANDOM%4] + 6`
```











### 调试




#### 检查脚本是否能正常运行

>本题的逻辑有些白痴，权当熟悉脚本用了。

如果可以正常运行，返回提示消息；如果运行错误，键入 V 或 v，会用 vim 自动打开脚本，键入 Q 或 q 或任意键可忽略并退出。

```bash
#!/bin/bash
if [ ${#1} == 0 ] ; then
  read -p "please type in the script name : " file
else
  file=$1
fi

# run the script if it's not empty
if [ -f $file ]; then
  sh -n $file > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    read -p "Syntax error detected. Press Q to exit. Press V to open it with vim" answer
    case $answer in
	v | V )
      vim $file
      ;;
    q | Q)
      exit 0
      ;;
    *)
      exit 0
      ;;
    esac
  else
    echo 'no error detected, congratulations!'
  fi
else
  echo "$file not exist"
  exit 1
fi
```





















### 文本流



#### 读取文件 特定行

读取文件第 5-15 行的内容。

```bash
$ cat test
1
2
3
4
5bbb
6xxxxxxxxxx  
7123i4i44
8
9
10
11
12
13ffffff
14fffff
15bbbbbb
16
17nnnnnn
```


##### grep

```bash
$ grep 15bbbbbb -B 10 test
```

提取关键字所在行，以及之 **前** 的 10 行。共计 10+1=11 行。

同理 `-A 10 ` 则表示提取关键字所在行，以及之 **后** 的 10 行。


##### sed

```bash
$ sed -n '5,15p' test
```


##### awk

```bash
$ awk '{if(NR<16 && NR>4) print $1}' test
```



























## 身份验证





### SSH


#### 生成密钥

```bash
$ ssh-keygen -o -t rsa -C "liloli@gmail.com" -b 4096
```
