---
toc: true
toc_label: "vSphere 6 - 可用性"
toc_icon: "code"
title: "vSphere 6 - 可用性"
tags: vmware vsphere ha
categories: "virtualization"
classes: wide
excerpt: "如何建立 vSphere High Availability  和 vSphere Fault Tolerance。"
header:
  overlay_image: /assets/images/header/frames.jpg
  overlay_filter: rgba(0, 0, 0, 0.6)
---



## 业务连续性和最小化停机时间

无论是计划停机时间还是非计划停机时间，都会带来相当大的成本。用于确保更高级别可用性的传统解决方案都需要较大开销，并且难以实施和管理。

VMware 可为重要应用程序提供更高级别的可用性，并且操作更简单，成本更低。

vSphere 可以实现：

* 更高的可用性：独立于硬件、操作系统和应用程序
* 减少日常维护的计划停机时间
* 出现故障时自动恢复

vSphere 可以减少计划的停机时间，防止出现非计划停机，并迅速从断电中恢复。





### 减少计划的停机时间

计划的停机时间通常占数据中心停机时间的 80% 以上。硬件维护、服务器迁移和固件更新均需要将物理服务器停机。为了最小化该停机时间所造成的影响，只得被迫延迟维护，直到出现不便且难以调度的停机时间段。

vSphere 可以显著减少计划的停机时间。由于 vSphere 环境中的工作负载无需停机或服务中断，就可以动态移动到其他物理服务器，所以服务器维护无需应用程序和服务停机就能执行。通过 vSphere 可以执行以下任务：

* 消除常见维护操作的停机时间
* 消除计划的维护时间段
* 随时执行维护，无需中断用户和服务

由于 VMware 环境中的工作负载无需中断服务即可动态移动到不同的物理服务器或基础存储器，所以，通过 vSphere 中的 vSphere vMotion 和 Storage vMotion 功能，企业可以减少计划的停机时间。管理员可以快速而完整地执行透明的维护操作，不必专门找时间来维护。






### 防止非计划停机时间

在 ESXi 主机为应用程序的运行提供稳定平台时，还应避免出现硬件或应用程序故障所导致的非计划停机时间。vSphere 将重要功能构建到数据中心基础架构中，这有助于避免出现非计划停机时间。

这些 vSphere 功能是虚拟基础架构的一部分，因此，对操作系统以及虚拟机中运行的应用程序而言是透明的。这些功能可以进行配置，而且可供物理系统上的所有虚拟机使用，从而降低成本并降低实现高可用性的复杂程度。vSphere 中内置的密钥可用性功能：

* **共享存储器**：通过在共享存储器（如光纤通道、iSCSI SAN 或 NAS）上存储虚拟机文件来消除单一故障点。可以使用 SAN 镜像和复制功能将虚拟磁盘的更新副本保留在灾难恢复站点。
* **网络接口绑定**：允许单个网卡发生故障。
* **存储多路径**：允许存储路径发生故障。

除了这些功能外，vSphere HA 和 Fault Tolerance 功能分别通过提供中断快速恢复和连续可用性来最小化或消除非计划停机时间。








### vSphere HA 提供快速中断恢复

vSphere HA 利用配置为集群的多台 ESXi 主机，为虚拟机中运行的应用程序提供快速中断恢复和具有成本效益的高可用性。



#### vSphere HA 通过以下方式保护应用程序可用性：

* 通过在集群内的其他主机上重新启动虚拟机，防止服务器故障。
* 通过持续监控虚拟机，并在检测到故障时对其进行重新设置，防止应用程序故障。
* 通过在同样有权访问其数据存储的其他主机上重新启动受影响的虚拟机，可防止出现数据存储可访问性故障。
* 如果虚拟机的主机在管理或 Virtual SAN 网络上被隔离，它会通过重新启动这些虚拟机来防止网络隔离。即使网络已分区，仍会提供此保护。



#### 与其他集群解决方案不同，vSphere HA 提供基础架构并使用该基础架构保护所有工作负载：

* 无需在应用程序或虚拟机内安装特殊软件。所有工作负载均受 vSphere HA 保护。配置 vSphere HA 之后，不需要执行操作即可保护新虚拟机。它们会自动受到保护。
* 可以将 vSphere HA 与 vSphere Distributed Resource Scheduler (DRS) 结合使用以防止出现故障，以及在集群内的主机之间提供负载平衡。



#### 与传统的故障切换解决方案相比，vSphere HA 具有多个优势：

##### 最小化设置

设置 vSphere HA 集群之后，集群内的所有虚拟机无需额外配置即可获得故障切换支持。

##### 减少了硬件成本和设置

虚拟机可充当应用程序的移动容器，可在主机之间移动。管理员会避免在多台计算机上进行重复配置。使用 vSphere HA 时，必须拥有足够的资源来对要通过 vSphere HA 保护的主机数进行故障切换。但是，vCenter Server 系统会自动管理资源并配置集群。

##### 提高了应用程序的可用性

虚拟机内运行的所有应用程序的可用性都变得更高。虚拟机可以从硬件故障中恢复，提高了在引导周期内启动的所有应用程序的可用性，而且没有额外的计算需求，即使该应用程序本身不是集群应用程序也一样。通过监控和响应 VMware Tools 检测信号并重新启动未响应的虚拟机，可防止客户机操作系统崩溃。

##### DRS 和 vMotion 集成

如果主机发生了故障，并且在其他主机上重新启动了虚拟机，则 DRS 会提出迁移建议或直接迁移虚拟机以平衡资源分配。如果迁移的源主机和/或目标主机发生故障，则 vSphere HA 会帮助从该故障中恢复。









### vSphere Fault Tolerance 提供连续可用性

vSphere HA 通过在主机出现故障时 **重新启动** 虚拟机来为虚拟机提供基本级别的保护。而 vSphere Fault Tolerance 可提供 **更高级别的可用性**，允许用户对任何虚拟机进行保护以防止主机发生故障时丢失数据、事务或连接。

Fault Tolerance 通过 “确保 **主虚拟机** 和 **辅助虚拟机** 的状态在虚拟机的指令执行的任何时间点均相同” 来提供连续可用性。
{: .notice}

如果运行主虚拟机的主机或运行辅助虚拟机的主机发生故障，则会发生即时且透明的故障切换。正常运行的 ESXi 主机将无缝变成主虚拟机的主机，而不会断开网络连接或中断正在处理的事务。使用透明故障切换，不会发生数据损失，并且可以保持网络的连接。在进行透明故障切换之后，将重新生成新的辅助虚拟机，并将重新建立冗余。整个过程是透明且全自动的，并且即使 vCenter Server 不可用，也会照常完成。






























## vSphere HA 集群

vSphere HA 集群允许 ESXi 主机集合作为一个组协同工作，这些主机为虚拟机提供的可用性级别比单独的 ESXi 主机提供的级别要高。当规划新 vSphere HA 集群的创建和使用时，有些选择会影响集群对主机或虚拟机故障的响应方式。

在创建 vSphere HA 集群之前，有必要了解 vSphere HA 是如何标识主机故障、隔离的，以及如何响应这些情况。还应了解接入控制的工作方式，以便可以选择符合故障切换需要的策略。建立集群之后，不但可以通过高级选项自定义其行为，还可以通过执行建议的最佳做法优化其性能。









### vSphere HA 的工作方式

vSphere HA 可以将虚拟机及其所驻留的主机集中在集群内，从而为虚拟机提供高可用性。集群中的主机均会受到监控，如果发生故障，故障主机上的虚拟机将在备用主机上重新启动。

创建 vSphere HA 集群时，会自动选择一台主机作为首选主机，master host。首选主机可与 vCenter Server 进行通信，并监控所有受保护的虚拟机以及从属主机的状态。如果发生了不同类型的主机故障，首选主机必须检测到并处理。首选主机必须有能力区分故障的类型，是主机发生故障，还是主机处于网络分区中，还是主机已与网络隔离。首选主机使用网络和数据存储的 **heartbeating** 检测信号来确定故障的类型。



#### 首选主机与从属主机

在将主机添加到 vSphere HA 集群时，会向该主机上传一个客户端程序，并进行适当的配置，以便其与集群内的其他客户端通信。集群中的每台主机的运行角色，要么是首选主机，要么是从属主机。

如果为集群启用了 vSphere HA，则所有活动主机（非待机、维护、断开连接的主机）都将参与选举，以选择集群的首选主机。所挂载的数据存储其数量最多的那台主机在选举中最具优势。每个集群通常只存在一台首选主机，其他所有主机都是从属主机。如果首选主机出现故障、关机、处于待机模式或从集群中被移除，则会进行新的选举。

首选主机与从属主机都可以在其上面运行虚拟主机，并对这些虚拟主机进行监控。

##### 首选主机的职责：

* 监控 **从属主机** 的状况：如果从属主机发生故障或无法访问，首选主机将确定需要重新启动的虚拟机。
* 监控所有受保护 **虚拟机的电源** 状况：如果有一台虚拟机出现故障，首选主机可确保重新启动该虚拟机。使用本地放置引擎（local placement engine），首选主机还可确定执行重新启动的位置。
* 管理集群 **主机和受保护的虚拟机列表**。
* 充当集群的 vCenter Server 管理中间人，并报告集群健康状况。

##### 从属主机的职责：

* 在本地运行虚拟机
* 监控虚拟机的运行时状况
* 向首选主机报告当前状态

首选主机执行的功能之一是安排受保护虚拟机的重新启动。在 vCenter Server 观察到某虚拟机的电源被打开之后，该虚拟机就会受到首选主机的保护。首选主机会将受保护虚拟机的列表保留在集群的数据存储中。新选的首选主机会使用该信息来确定要保护哪些虚拟机。

如果断开主机与集群之间的连接，则所有向该主机注册的虚拟机均不受 vSphere HA 保护。
{: .notice}





#### 主机故障类型和检测

首选主机负责检测从属主机的故障。根据检测到的故障类型，在主机上运行的虚拟机可能需要进行故障切换。

在 vSphere HA 群集中，可以检测三种类型的主机故障：

* **故障** - 主机停止运行
* **隔离** - 主机与网络隔离
* **分区** - 主机失去与首选主机的网络连接

首选主机监控群集中从属主机的活跃度。通过每秒交换一次 heartbeat 来完成一次通信。当首选主机接收不到某从属主机的信号时，它会先检查主机的活跃度，然后声明该主机已出现故障。所谓活跃度检查，是判断该从属主机与数据存储之间是否在交换 heartbeat 信号。请参见数据存储检测信号。而且，首选主机还检查主机是否对发送至其管理 IP 地址的 ICMP ping 进行响应。

如果首选主机无法直接与从属主机上的代理进行通信，则该从属主机不会对 ICMP ping 进行响应，并且该代理不会发出被视为已出现故障的检测信号。会在备用主机上重新启动主机的虚拟机。如果此类从属主机与数据存储交换检测信号，则首选主机会假定它处于某个网络分区或隔离网络中，因此会继续监控该主机及其虚拟机。请参见网络分区。

当主机仍在运行但无法再监视来自管理网络上 vSphere HA 代理的流量时，会发生主机网络隔离。如果主机停止监视此流量，则它会尝试 ping 群集隔离地址。如果仍然失败，主机将声明自己已与网络隔离。

首选主机监控在独立主机上运行的虚拟机，如果发现虚拟机的电源已关闭，而且该首选主机负责这些虚拟机，则会重新启动这些虚拟机。

只要能够确认网络具有足够的冗余度，任何时候肯定至少有一个网络路径可用，则主机网络隔离会极少出现。
{: .notice}
