---
toc: true
toc_label: "Nginx 常用配置"
toc_icon: "copy"
title: "Nginx 常用配置"
tags: nginx 配置
categories: "server"
classes: wide
excerpt: "反向代理，"
header:
  overlay_image: /assets/images/header/nginx.jpeg
  overlay_filter: rgba(0, 0, 0, 0.8)
---


## 反向代理

本节中，nginx 的身份均为直接面向用户的反向代理服务器。
{: .notice}



### 获取用户真实 IP  地址

为了实现反向代理，nginx 增加了 `ngx_http_proxy_module` 模块。配置文件中的 `proxy_set_header` 指令即属于该模块。  



#### 配置方法


```conf
proxy_set_header Host $host;
proxy_set_header X-Forward-For $remote_addr;
```

`$host` 和 `$remote_addr` 都是 nginx 的 **导出变量**。



#### `Host` 字段

HTTP 请求头中的 **Host** 字段表示所请求的 **目的主机名**。

如果后端 web 服务器使用了类似防盗链功能，或者根据 HTTP header 中的 Host 字段来进行路由或过滤功能的话，nginx 必须重写请求头中的 Host 字段，否则会导致请求失败。

为什么不用 $http_host 而用 $host：

变量 $http_host 与 $host 同样都能表示请求头中的 Host 字段，为什么不用前者？

如果 Host 字段没有出现在 HTTP 头中，$http_host 的变量值将为 **空**，而 $host 却会使用实际处理的虚拟主机的 server_name 做为变量值。因此通常会用 $host 来代替 $http_host 变量，从而避免 http 请求中丢失 Host 头部的情况下，Host 字段不被重写的失误。



#### `X-Forward-For`

HTTP 请求头中的 **X_Forward_For** 字段表示该 **请求是从哪个地址发出** 的。

如果 nginx 不重写该请求头，后端 web 服务器在处理时会认为所有的请求都来自 nginx 。如果后端 web 服务器有防攻击策略的话，那么 nginx 的 ip 地址就会被封掉。















因为服务器集群之间的通信是可以信任的，所以只需在离用户最近的前端代理上，强制设定 `X-Forward-For`，后端所有机器无需任何设置，直接信任并使用前端机器传递过来的 `X-Forward-For` 值即可。

配置 nginx ：

```conf
location  ~  ^/static {
    proxy_pass  ....;
    proxy_set_header X-Forward-For $remote_addr ;
}
```

`$remote_addr` 是 nginx 的 **内置变量**，代表了客户端真实 IP 地址。通过该设置，强行将 `X-Forward-For` 设置为客户端地址，使客户端无法伪造 IP 地址。
{: .notice}

可以配置 `X-Forward-For` 把发送者 ip 地址、代理服务器 ip 地址同时记录下来，用逗号分隔。


##### 后端服务器如何获取用户真实地址

反向代理在客户端和 web 服务器之间增加了中间层，因此 web 服务器无法直接拿到客户端的 ip 地址，在 web 服务器上通过 `$remote_addr` 变量拿到的是 nginx 的 ip 地址。

而在反向代理服务器上，nginx 使用 `$remote_addr` 变量获得的是用户的真实地址。

要想在 web 服务器上也能获取用户的真实地址，就必须在 nginx 上自定义一个变量，为其赋值 `$remote_addr`：

```conf
proxy_set_header x-real-ip $remote_addr;
```

`x-real-ip` 是一个自定义头部字段，它通常被 HTTP 代理用来表示与它产生 TCP 连接的设备 IP，这个设备可能是其他代理，也可能是真正的请求端。需要注意的是，`x-real-ip` 目前并不属于任何标准，代理和 Web 应用之间可以约定用任何自定义头来传递这个信息。

这样，用户的真实 ip 地址就置于 `x-real-ip` 变量中了，在 web 服务器端可以通过类似如下 API 读取该变量值，从而获取客户端真实地址：

```conf
request.getAttribute("X-real-ip")
```


##### `X-Forwarded-For` 简介

X-Forwarded-For 是一个 HTTP 扩展头部。HTTP/1.1（RFC 2616）协议并没有对它的定义，它最开始是由 Squid 这个缓存代理软件引入，用来表示 HTTP 请求端真实 IP。如今它已经成为事实上的标准，被各大 HTTP 代理、负载均衡等转发服务广泛使用，并被写入 [RFC 7239](http://tools.ietf.org/html/rfc7239)（Forwarded HTTP Extension）标准之中。

X-Forwarded-For 请求头格式非常简单，就这样：

```shell
X-Forwarded-For: client, proxy1, proxy2
```

可以看到，XFF 的内容由「英文逗号 + 空格」隔开的多个部分组成，最开始的是离服务端最远的设备 IP，然后是每一级代理设备的 IP。

如果一个 HTTP 请求到达服务器之前，经过了三个代理 Proxy1、Proxy2、Proxy3，IP 分别为 IP1、IP2、IP3，用户真实 IP 为 IP0，那么按照 XFF 标准，服务端最终会收到以下信息：

```shell
X-Forwarded-For: IP0, IP1, IP2
```

Proxy3 直连服务器，它会给 XFF 追加 IP2，表示它是在帮 Proxy2 转发请求。列表中并没有 IP3，IP3 可以在服务端通过 Remote Address 字段获得。我们知道 HTTP 连接基于 TCP 连接，HTTP 协议中没有 IP 的概念，Remote Address 来自 TCP 连接，表示与服务端建立 TCP 连接的设备 IP，在这个例子里就是 IP3。

Remote Address 无法伪造，因为建立 TCP 连接需要三次握手，如果伪造了源 IP，无法建立 TCP 连接，更不会有后面的 HTTP 请求。
