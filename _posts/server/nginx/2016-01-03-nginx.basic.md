---
toc: true
toc_label: "Nginx 简介及基本功能"
toc_icon: "copy"
title: "Nginx 简介及基本功能"
tags: nginx
categories: "server"
classes: wide
excerpt: ""
header:
  overlay_image: /assets/images/header/nginx.jpeg
  overlay_filter: rgba(0, 0, 0, 0.8)
---




## 简介

了解 Nginx 最好的办法就是将其与 Apache 进行对照。

Apache 1995 年就开始被广泛使用，支撑了最多的网站，其次就是微软的 IIS。

开源的 Apache 这么多年来如此广泛地应用，拥有如此多的用户，因此产生了很多的模块来扩展其功能，这些模块大多也是开源的。

但 Apache 在高负载下会变得缓慢，因为它总是要产生新的进程，会消耗更多的内存。








## 控制 nginx 运行时进程





### 主进程与工人进程

nginx 有一个主进程与一个或多个工人进程。如果启用了缓存，在启动服务时还会运行缓存启动器进程和缓存管理器进程。

主进程的主要任务是读取和验证配置文件，维护工人进程。
{: .notice}

工人进程的任务则是处理请求。nginx 靠的是依赖于操作系统的机制，把请求高效地分配给工人进程。工人进程的数量由配置文件定义，可以是固定的，也可以根据可用 CPU 核心的数量来自动调整。






### nginx 的控制




#### 用信号控制进程

nginx 可以由信号来控制，主进程的 ID 默认被写入 `/run/nginx.pid` 文件。


##### 主进程支持以下信号：

`GERM`,`INT` ：快速关闭

`QUIT` ：优雅关闭

`HUP` ：修改配置，修改了时区，用新配置开启新工人进程，优雅关闭旧工人进程

`USR1` ：重新打开日志文件

`USR2` ：升级可执行文件

`WINCH` ：优雅关闭工人进程


##### 工人进程支持的信号：

单独的工人进程也可以由信号来控制，虽然并不需要这么做。

`TERM`,`INT` ：快速关闭

`QUIT` ：优雅关闭

`USR1` ：重新打开日志文件

`WINCH` ：异常终止，用于调试，需启用 `debug_points`



##### 重载配置

要想重载配置，可以停止或重启 nginx ，或向主进程发送信号。可以用 `nginx -s` 命令来发送信号：

```bash
nginx -s <SIGNAL>
```

`<SIGNAL>` 可以是以下信号：

* `stop` ：快速关闭
* `quit` ：优雅关闭
* `reload` ：重新加载配置文件
* `reopen` ：重新打开日志文件

```shell
nginx -s reload
```


##### 用 `kill` 发信号

还可以用 `kill` 命令直接给主进程发信号，这种情况下会直接把信号发给指定 PID 的进程。

```bash
ps -ax | grep nginx
  3129 ?        Ss     0:00 nginx: master process /usr/sbin/nginx

kill -s QUIT 3129
```




#### 修改配置

为了让 nginx 重新读取配置文件，可以向主进程发送 `HUP` 信号。

主进程首先会检查语法是否正确，然后会尝试应用新的配置，即，打开日志文件及新的侦听套接字。

如果失败，回滚本次所做的修改，继续用旧配置工作。

如果成功，开启新的工人进程，并向旧工人进程发送消息，要求它们优雅关闭。旧工人进程关闭侦听套接字，继续处理之前的请求，处理完毕以后，旧工人进程关闭。





#### 滚动日志文件

滚动日志文件之前，需要先重命名旧日志文件。

之后，应该向主进程发送 `USR1` 信号。主进程会把当前打开的日志文件重新打开，并为其分配一个普通权限的用户，以该用户身份来运行工人进程。

在成功地重新打开之后，主进程关闭所有打开的文件，向工人进程发送消息，要求它们重新打开文件。

工人进程同样地马上打开新文件，关闭旧文件。

此时，旧文件几乎可以立即用于后期处理，如压缩。




#### 在线升级可执行文件

升级可执行文件时，要先用新的可执行文件把旧的替换掉。

之后，向主进程发送 `USR2` 信号。

主进程先是重命名其 PID 文件，在原文件名基础上添加后缀 `.oldbin`，如 `nginx.pid.oldbin`；然后再运行新的可执行文件，随之启动新的工人进程。

之后，所有的新旧工人进程继续接受请求。如果向第一个主进程发送了 `WINCH` 信号，它会向其工人进程发送消息，要求它们优雅关闭，它们会开始退出。

过了一段时间，只有新的工人来处理请求。

要注意的一点是，旧的主进程不会关闭其侦听套接字，需要时可以再次启动其工人进程。

如果新的可执行文件由于某种原因工作不正常，可以选择以下操作之一：

* 向旧主进程发送 `HUP` 信号。旧主进程会启动新的工人进程，不会重新读取配置。然后，向新主进程发送 `QUIT` 信号，其工人进程可被优雅关闭。
* 向新主进程发送 `TERM` 信号。它会发消息给其工人进程，要求它们立即退出，于是这些工人进程几乎会立即退出。如果没能退出，可以向它们发送 `KILL` 信号来强制退出。新主进程退出之后，旧主进程会自动启动新工人进程。

如果新的主进程退出，则旧主进程会丢弃 `.oldbin` 后缀，恢复 PID 文件名。

如果升级成功，应该向旧主进程发送 `QUIT` 信号，最后只留下新进程。































## 创建配置文件

nginx 也是使用文本格式的配置文件，默认文件名为 `/etc/nginx/nginx.conf`。




#### 指令

配置文件由指令及其参数组成。

简单指令以分号结尾。其它指令充当 “容器”，可以把相关的指令放在一起，外面用大括号包围，通常称之为 “块”。




#### 特定功能的配置文件

为了让配置更易于维护，建议把配置文件分割成一组特定功能的文件，保存在`/etc/nginx/conf.d` 目录中，然后在主配置文件中用 `include` 指令来引用。




#### contexts

有几个最高层的指令，被称为 context，它把应用到不同流量类型的指令集中到一起：

`events` ：一般连接的处理

`http` ：HTTP 流量

`mail` ：邮件流量

`stream` ：TCP 和 UDP 流量

置于这些 context 之外的指令被称为处于 main context 之中。


##### 虚拟服务器

在每个用来处理流量的 context 中，可以包含一个或多个 `server` 块来定义虚拟服务器，用它来控制对请求的处理。在 `server` 中可以容纳的指令依流量类型而有所不同。

对于 HTTP 流量来说，每个 `server` 指令是用来控制那些 “对特定域名或 IP 地址中资源的” 请求的。`server` 中，用一个或多个 `location` 来定义如何处理特定的网址。

对于 mail 和 TCP/UDP  流量来说，每个 `server` 指令用来控制 “抵达特定 TCP 端口或 UNIX 套接字的” 流量的处理。


##### 多 context 配置文件范例

```conf
user nobody; # 'main' context 中的一个指令

events {
    # 配置如何处理连接
}

http {
    # 此处配置为 HTTP 专用，并影响所有虚拟服务器  

    server {
        # 1 号 HTTP 虚拟服务器的配置
        location /one {
            # 如何处理以 '/one' 开头的网址
        }
        location /two {
            # 如何处理以 '/two' 开头的网址
        }
    }

    server {
        # 2 号 HTTP 虚拟服务器的配置
    }
}

stream {
    # 此处配置为 TCP/UDP 专用，并影响所有虚拟服务器
    server {
        # 1 号 TCP 虚拟服务器的配置
    }
}
```


##### 继承

一般来说，子 context 会继承上一层级指令的配置。有一些指令可以出现在多个 context 中，此时，子 context 中的指令会覆盖其从上层继承来的对应的指令。




#### 重载配置

要想让配置文件的修改生效，必须将其重载。可以重启 `nginx` 进程，也可以向其发送 `reload` 信号，更新配置的同时，不会打扰对当前请求的处理。
